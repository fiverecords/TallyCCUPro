<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TallyCCU Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ============================================
   TallyCCU Pro - Professional UI Design
   ============================================ */

:root {
  --bg-primary: #1a1a1c;
  --bg-secondary: #232326;
  --bg-tertiary: #2a2a2e;
  --bg-panel: #1e1e21;
  --bg-input: #333338;
  --bg-hover: #35353a;
  
  --border-color: #3a3a40;
  --border-light: #454550;
  --border-focus: #5a8fd9;
  
  --text-primary: #e8e8e8;
  --text-secondary: #a0a0a5;
  --text-muted: #6a6a70;
  --text-label: #c8c8cc;
  
  --accent-blue: #4a90d9;
  --accent-blue-hover: #5a9fe8;
  --accent-orange: #e87a35;
  --accent-green: #4caf50;
  --accent-red: #e53935;
  
  --tally-pgm: #e53935;
  --tally-pvw: #43a047;
  
  --lift-color: #5588cc;
  --gamma-color: #888888;
  --gain-color: #cc9955;
  --offset-color: #8855aa;
  
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 12px;
  --spacing-lg: 16px;
  --spacing-xl: 20px;
  
  --radius-sm: 3px;
  --radius-md: 4px;
  --radius-lg: 6px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 13px;
  line-height: 1.4;
  min-height: 100vh;
}

/* === HEADER === */
.header {
  background: linear-gradient(180deg, #2d2d32 0%, var(--bg-secondary) 100%);
  border-bottom: 1px solid var(--border-color);
  padding: var(--spacing-md) var(--spacing-xl);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-left {
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
}

.logo {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.logo-accent { color: var(--accent-orange); }

.logo-sub {
  font-size: 11px;
  font-weight: 400;
  color: var(--text-muted);
  margin-left: var(--spacing-md);
  padding-left: var(--spacing-md);
  border-left: 1px solid var(--border-color);
}

.header-nav {
  display: flex;
  gap: var(--spacing-sm);
}

.nav-btn {
  padding: var(--spacing-sm) var(--spacing-lg);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.nav-btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
  border-color: var(--border-light);
}

/* === CAMERA SELECTOR === */
.camera-strip {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  padding: var(--spacing-sm) var(--spacing-xl);
  display: flex;
  justify-content: center;
  gap: 6px;
}

.camera-btn {
  flex: 0 0 auto;
  min-width: 60px;
  max-width: 90px;
  padding: 10px 12px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
  position: relative;
  overflow: hidden;
}

.camera-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: transparent;
  transition: background 0.15s ease;
}

.camera-btn:hover {
  background: var(--bg-hover);
  border-color: var(--border-light);
  color: var(--text-primary);
}

.camera-btn.active-camera {
  background: linear-gradient(180deg, #2a3a4a 0%, #1e2e3e 100%);
  border-color: var(--accent-blue);
  color: var(--text-primary);
}

.camera-btn.active-camera::before { background: var(--accent-blue); }

.camera-btn.tally-pgm {
  background: linear-gradient(180deg, #3d2020 0%, #2a1515 100%);
  border-color: var(--tally-pgm);
  color: #ff8080;
}

.camera-btn.tally-pgm::before { background: var(--tally-pgm); }

.camera-btn.tally-pvw {
  background: linear-gradient(180deg, #203d20 0%, #152a15 100%);
  border-color: var(--tally-pvw);
  color: #80ff80;
}

.camera-btn.tally-pvw::before { background: var(--tally-pvw); }

/* === TOOLBAR === */
.toolbar {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  padding: var(--spacing-md) var(--spacing-xl);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: var(--spacing-md);
}

.toolbar-group {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.toolbar-label {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-right: var(--spacing-xs);
}

.toolbar-btn {
  padding: 6px 12px;
  font-size: 11px;
  font-weight: 500;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s ease;
}

.toolbar-btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.toolbar-btn.active {
  background: var(--accent-green);
  border-color: var(--accent-green);
  color: white;
}

.toolbar-btn.danger { color: var(--accent-red); }

.toolbar-btn.danger:hover {
  background: var(--accent-red);
  border-color: var(--accent-red);
  color: white;
}

.toolbar-divider {
  width: 1px;
  height: 24px;
  background: var(--border-color);
  margin: 0 var(--spacing-sm);
}

/* === PRESETS === */
/* Presets Panel - Slide-out */
.presets-toggle {
  position: fixed;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-right: none;
  border-radius: 8px 0 0 8px;
  padding: 12px 8px;
  cursor: pointer;
  z-index: 1000;
  transition: all 0.3s ease;
  writing-mode: vertical-rl;
  text-orientation: mixed;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  letter-spacing: 1px;
  text-transform: uppercase;
}

.presets-toggle:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  padding-right: 12px;
}

.presets-toggle.panel-open {
  right: 280px;
}

.presets-panel {
  position: fixed;
  right: -280px;
  top: 0;
  width: 280px;
  height: 100vh;
  background: var(--bg-secondary);
  border-left: 1px solid var(--border-color);
  z-index: 999;
  transition: right 0.3s ease;
  display: flex;
  flex-direction: column;
  box-shadow: -4px 0 20px rgba(0,0,0,0.3);
}

.presets-panel.open {
  right: 0;
}

.presets-panel-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.presets-panel-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.presets-panel-close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 18px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.15s;
}

.presets-panel-close:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.presets-list {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.preset-card {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 12px;
  transition: all 0.15s;
}

.preset-card:hover {
  border-color: var(--border-focus);
}

.preset-card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}

.preset-card-number {
  width: 24px;
  height: 24px;
  background: var(--bg-hover);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
}

.preset-card .preset-name {
  flex: 1;
  padding: 6px 10px;
  font-size: 12px;
  font-family: inherit;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
}

.preset-card .preset-name:focus {
  outline: none;
  border-color: var(--border-focus);
}

.preset-card-actions {
  display: flex;
  gap: 6px;
}

.preset-card-btn {
  flex: 1;
  padding: 8px 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.preset-card-btn.save {
  background: var(--bg-hover);
  color: var(--text-secondary);
}

.preset-card-btn.save:hover {
  background: var(--accent-blue);
  color: white;
}

.preset-card-btn.load {
  background: var(--accent-green);
  color: white;
}

.preset-card-btn.load:hover {
  background: #5cbf60;
}

.presets-panel-footer {
  padding: 12px;
  border-top: 1px solid var(--border-color);
}

.preset-reset-btn {
  width: 100%;
  padding: 10px;
  background: transparent;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.preset-reset-btn:hover {
  background: var(--accent-orange);
  border-color: var(--accent-orange);
  color: white;
}

.presets-section {
  padding: 12px;
  border-bottom: 1px solid var(--border-color);
}

.presets-section-title {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: 10px;
}

.group-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.group-chip {
  display: flex;
  align-items: center;
  cursor: pointer;
}

.group-chip input {
  display: none;
}

.group-chip span {
  padding: 5px 10px;
  font-size: 11px;
  font-weight: 500;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  color: var(--text-muted);
  transition: all 0.15s;
}

.group-chip:hover span {
  border-color: var(--border-focus);
  color: var(--text-secondary);
}

.group-chip input:checked + span {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.group-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.group-action-btn {
  flex: 1;
  padding: 6px 12px;
  font-size: 11px;
  font-weight: 500;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}

.group-action-btn:hover {
  background: var(--bg-hover);
  border-color: var(--border-focus);
  color: var(--text-primary);
}

/* === APP LAYOUT === */
.app-layout {
  display: flex;
  min-height: calc(100vh - 200px);
}

/* === SIDEBAR === */
.sidebar {
  width: 160px;
  min-width: 160px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border-color);
  padding: var(--spacing-md) 0;
  position: sticky;
  top: 0;
  height: fit-content;
  max-height: calc(100vh - 200px);
  overflow-y: auto;
}

.sidebar-section {
  padding: 0 var(--spacing-sm);
}

.sidebar-title {
  display: block;
  font-size: 10px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: var(--spacing-sm) var(--spacing-md);
  margin-bottom: var(--spacing-xs);
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.sidebar-tab {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: 10px var(--spacing-md);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  background: transparent;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s ease;
  text-align: left;
  width: 100%;
}

.sidebar-tab .tab-icon {
  font-size: 14px;
  flex-shrink: 0;
}

.sidebar-tab .tab-text {
  white-space: nowrap;
}

.sidebar-tab:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.sidebar-tab.active-tab {
  background: var(--accent-blue);
  color: white;
}

/* === MAIN CONTENT === */
.main-content {
  flex: 1;
  padding: var(--spacing-xl);
  min-width: 0;
  overflow-x: hidden;
}

.tabcontent { display: none; }

/* === RESPONSIVE SIDEBAR === */
@media (max-width: 1100px) {
  .sidebar {
    width: 52px;
    min-width: 52px;
  }
  
  .sidebar-title {
    display: none;
  }
  
  .sidebar-tab {
    justify-content: center;
    padding: 12px 8px;
  }
  
  .sidebar-tab .tab-text {
    display: none;
  }
  
  .sidebar-tab .tab-icon {
    font-size: 18px;
  }
}

@media (max-width: 600px) {
  .app-layout {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    min-width: 100%;
    max-height: none;
    border-right: none;
    border-bottom: 1px solid var(--border-color);
    position: relative;
    padding: var(--spacing-sm);
  }
  
  .sidebar-section {
    padding: 0;
  }
  
  .sidebar-nav {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    gap: 4px;
  }
  
  .sidebar-tab {
    width: auto;
    padding: 8px 10px;
    justify-content: center;
  }
  
  .sidebar-tab .tab-text {
    display: none;
  }
  
  .sidebar-tab .tab-icon {
    font-size: 16px;
  }
  
  .sidebar-title {
    display: none;
  }
  
  /* Presets panel responsive */
  .presets-toggle {
    top: auto;
    bottom: 0;
    right: 20px;
    transform: none;
    writing-mode: horizontal-tb;
    border-radius: 8px 8px 0 0;
    border: 1px solid var(--border-color);
    border-bottom: none;
    padding: 8px 16px;
    transition: opacity 0.2s ease;
  }
  
  .presets-toggle.panel-open {
    opacity: 0;
    pointer-events: none;
  }
  
  .presets-panel {
    width: 100%;
    height: 70vh;
    right: 0;
    bottom: -70vh;
    top: auto;
    transition: bottom 0.3s ease;
  }
  
  .presets-panel.open {
    bottom: 0;
  }
}

/* === CONTROL PANELS === */
.control-panel {
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  margin-bottom: var(--spacing-lg);
  overflow: hidden;
}

.control-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-md) var(--spacing-lg);
  background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
  border-bottom: 1px solid var(--border-color);
}

.control-panel-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-primary);
}

.panel-action-btn {
  padding: 5px 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--accent-blue);
  background: transparent;
  border: 1px solid var(--accent-blue);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s ease;
}

.panel-action-btn:hover {
  background: var(--accent-blue);
  color: white;
}

.control-panel-body {
  padding: var(--spacing-lg);
}

.control-row {
  display: flex;
  gap: var(--spacing-xl);
  justify-content: center;
  flex-wrap: wrap;
}

.slider-row {
  display: flex;
  gap: var(--spacing-xl);
  align-items: flex-start;
  flex-wrap: wrap;
}

/* === KNOB CONTROLS === */
.knob-control {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 120px;
}

.knob-control > label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: var(--spacing-md);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
}

.knob-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-sm);
}

.knob-with-buttons {
  display: flex;
  align-items: center;
  gap: 8px;
}

.knob-pm-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 1px solid var(--border-color);
  background: var(--bg-tertiary);
  color: var(--text-primary);
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
}

.knob-pm-btn:hover {
  background: var(--bg-hover);
  border-color: var(--accent-blue);
}

.knob-pm-btn:active {
  background: var(--accent-blue);
  transform: scale(0.95);
}

.knob {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: linear-gradient(145deg, #2a2a30, #1a1a1e);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);
  position: relative;
  cursor: pointer;
}

.knob:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.08);
}

.knob-track {
  position: absolute;
  top: 6px;
  left: 6px;
  right: 6px;
  bottom: 6px;
  border-radius: 50%;
  border: 2px solid var(--bg-tertiary);
}

.knob-indicator {
  position: absolute;
  width: 4px;
  height: 16px;
  background: var(--accent-blue);
  border-radius: 2px;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  transform-origin: center 27px;
  box-shadow: 0 0 6px var(--accent-blue);
}

.knob-input {
  width: 60px;
  padding: 5px 6px;
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 500;
  text-align: center;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  cursor: default;
  pointer-events: none;
}

.knob-input:focus {
  outline: none;
}

.knob-input::-webkit-inner-spin-button,
.knob-input::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.knob-presets {
  display: flex;
  gap: 3px;
  margin-top: var(--spacing-xs);
  flex-wrap: wrap;
  justify-content: center;
}

.knob-presets button {
  padding: 3px 6px;
  font-size: 9px;
  font-weight: 600;
  color: var(--text-muted);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  cursor: pointer;
}

.knob-presets button:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.knob-presets button.auto-btn {
  color: var(--accent-blue);
  border-color: var(--accent-blue);
}

.knob-presets button.auto-btn:hover {
  background: var(--accent-blue);
  color: white;
}

/* ND Mode mini buttons */
.nd-mode-mini {
  display: flex;
  gap: 2px;
  margin-top: 4px;
  justify-content: center;
}

.nd-mode-btn {
  padding: 2px 5px;
  font-size: 8px;
  font-weight: 600;
  color: var(--text-muted);
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.nd-mode-btn:hover {
  color: var(--text-secondary);
}

.nd-mode-btn.active {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

/* === STYLED SLIDERS === */
.slider-control {
  flex: 1;
  min-width: 180px;
  max-width: 300px;
}

.slider-control.wide {
  flex: 2;
  max-width: 450px;
}

.slider-control.full {
  flex: 1;
  max-width: 100%;
}

.slider-header {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-sm);
}

.slider-header label {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-secondary);
}

.slider-reset {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 12px;
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 4px;
  opacity: 0.6;
  transition: all 0.15s;
  margin-left: auto;
}

.slider-reset:hover {
  opacity: 1;
  background: var(--bg-hover);
  color: var(--text-primary);
}

.slider-input {
  width: 55px;
  padding: 4px 6px;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  text-align: right;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  cursor: default;
  pointer-events: none;
}

.slider-input:focus {
  outline: none;
}

.slider-unit {
  font-size: 10px;
  color: var(--text-muted);
  margin-left: 2px;
}

.slider-track-container {
  position: relative;
  height: 24px;
  display: flex;
  align-items: center;
}

.slider-gradient {
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 8px;
  transform: translateY(-50%);
  border-radius: 4px;
  pointer-events: none;
}

.slider-gradient.temp-gradient {
  background: linear-gradient(to right, #ff8c42 0%, #ffd166 30%, #ffffff 50%, #a8daff 70%, #6eb5ff 100%);
}

.slider-gradient.tint-gradient {
  background: linear-gradient(to right, #4caf50 0%, #888888 50%, #e040fb 100%);
}

.styled-slider {
  width: 100%;
  height: 24px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--bg-tertiary);
  border-radius: 4px;
  position: relative;
  z-index: 2;
}

.styled-slider.has-gradient {
  background: transparent;
}

.styled-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: white;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 1px 4px rgba(0,0,0,0.4);
}

.styled-slider::-webkit-slider-thumb:hover {
  transform: scale(1.1);
}

.slider-labels {
  display: flex;
  justify-content: space-between;
  margin-top: 4px;
  font-size: 9px;
  color: var(--text-muted);
}

/* === SETTINGS GRID === */
.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: var(--spacing-lg);
}

.setting-item {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.setting-item > label {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-secondary);
}

/* === STYLED SELECT === */
.styled-select {
  width: 100%;
  padding: 8px 12px;
  font-size: 12px;
  font-family: inherit;
  color: var(--text-primary);
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236a6a70' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
}

.styled-select:hover {
  border-color: var(--border-light);
}

.styled-select:focus {
  outline: none;
  border-color: var(--accent-blue);
}

.styled-select option {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

/* === TOGGLE GROUPS === */
.toggle-group {
  display: flex;
  flex-wrap: wrap;
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  padding: 3px;
  gap: 3px;
}

.toggle-btn {
  flex: 1 1 auto;
  min-width: 0;
  padding: 6px 8px;
  font-size: 10px;
  font-weight: 600;
  color: var(--text-muted);
  background: transparent;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.toggle-btn:hover {
  color: var(--text-secondary);
  background: rgba(255,255,255,0.05);
}

.toggle-btn.active {
  color: white;
  background: var(--accent-blue);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* === SWITCH TOGGLE === */
.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.switch-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-tertiary);
  border-radius: 24px;
  transition: all 0.2s ease;
  border: 1px solid var(--border-color);
}

.switch-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 2px;
  bottom: 2px;
  background: var(--text-secondary);
  border-radius: 50%;
  transition: all 0.2s ease;
}

.switch input:checked + .switch-slider {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
}

.switch input:checked + .switch-slider:before {
  transform: translateX(20px);
  background: white;
}

/* === CHECKBOX GROUP === */
.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-md);
}

.checkbox-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--text-secondary);
}

.checkbox-item input {
  width: 14px;
  height: 14px;
  accent-color: var(--accent-blue);
}

/* === COLOR CORRECTION PANEL === */
.color-panel {
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
  margin-bottom: var(--spacing-xl);
}

.color-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-md) var(--spacing-lg);
  background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
  border-bottom: 1px solid var(--border-color);
}

.color-panel-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.color-panel-btn {
  padding: 5px 12px;
  font-size: 11px;
  font-weight: 500;
  color: var(--accent-orange);
  background: transparent;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  cursor: pointer;
}

.color-panel-btn:hover {
  background: var(--accent-orange);
  border-color: var(--accent-orange);
  color: white;
}

.color-wheels-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-xl);
  padding: var(--spacing-xl);
}

.color-wheel-group {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.wheel-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: var(--spacing-md);
}

.wheel-reset {
  width: 18px;
  height: 18px;
  font-size: 10px;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: 3px;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}

.wheel-reset:hover {
  background: var(--accent-orange);
  border-color: var(--accent-orange);
  color: white;
}

.wheel-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.wheel-title.lift { color: var(--lift-color); }
.wheel-title.gamma { color: #aaaaaa; }
.wheel-title.gain { color: var(--gain-color); }
.wheel-title.offset { color: var(--offset-color); }

.color-wheel {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  background: conic-gradient(from 90deg, 
    hsl(0,70%,50%) 0deg,
    hsl(60,70%,45%) 60deg, 
    hsl(120,70%,40%) 120deg,
    hsl(180,70%,45%) 180deg,
    hsl(240,70%,50%) 240deg,
    hsl(300,70%,50%) 300deg,
    hsl(0,70%,50%) 360deg
  );
  position: relative;
  cursor: crosshair;
  box-shadow: inset 0 0 25px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.3);
}

.color-wheel::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 65%;
  height: 65%;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(90,90,90,0.9) 0%, rgba(90,90,90,0.3) 60%, transparent 100%);
}

.wheel-pointer {
  position: absolute;
  width: 12px;
  height: 12px;
  border: 2px solid white;
  border-radius: 50%;
  background: rgba(0,0,0,0.4);
  transform: translate(-50%, -50%);
  top: 50%;
  left: 50%;
  z-index: 10;
  box-shadow: 0 0 6px rgba(0,0,0,0.6);
  pointer-events: none;
}

.wheel-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 5px;
  height: 5px;
  background: var(--text-muted);
  border-radius: 50%;
  z-index: 5;
}

.wheel-master {
  width: 100%;
  margin-top: var(--spacing-md);
  padding: 0 8px;
}

.master-slider {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--bg-tertiary);
  border-radius: 3px;
}

.master-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: var(--text-primary);
  border-radius: 50%;
  cursor: pointer;
}

.master-slider.lift::-webkit-slider-thumb { background: var(--lift-color); }
.master-slider.gamma::-webkit-slider-thumb { background: #aaaaaa; }
.master-slider.gain::-webkit-slider-thumb { background: var(--gain-color); }
.master-slider.offset::-webkit-slider-thumb { background: var(--offset-color); }

.wheel-values {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 3px;
  margin-top: var(--spacing-sm);
  width: 100%;
}

.wheel-value {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

.wheel-value label {
  font-size: 9px;
  font-weight: 700;
}

.wheel-value label.r { color: #e05555; }
.wheel-value label.g { color: #55e055; }
.wheel-value label.b { color: #5588ee; }
.wheel-value label.y { color: #aaaaaa; }

.wheel-value input {
  width: 34px;
  padding: 2px;
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  text-align: center;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 2px;
  color: var(--text-primary);
}

.color-controls-row {
  display: flex;
  gap: var(--spacing-xl);
  padding: var(--spacing-lg) var(--spacing-xl);
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-color);
  flex-wrap: wrap;
}

/* === CONTRAST / PIVOT VISUAL CONTROL === */
.contrast-pivot-control {
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  padding: var(--spacing-md);
  min-width: 180px;
  flex: 1;
  overflow: hidden;
}

.cp-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.cp-header span {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.mini-reset {
  width: 22px;
  height: 22px;
  font-size: 12px;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  cursor: pointer;
}

.mini-reset:hover {
  background: var(--accent-orange);
  border-color: var(--accent-orange);
  color: white;
}

.cp-visual {
  width: 100%;
  height: 100px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  margin-bottom: var(--spacing-sm);
  overflow: hidden;
  position: relative;
}

.contrast-curve {
  width: 100%;
  height: 100%;
  display: block;
}

.pivot-marker {
  position: absolute;
  width: 10px;
  height: 10px;
  background: #e87a35;
  border: 2px solid white;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  top: 50%;
  left: 50%;
  pointer-events: none;
  box-shadow: 0 1px 3px rgba(0,0,0,0.4);
}

.cp-sliders {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.cp-slider {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.cp-slider label {
  font-size: 10px;
  color: var(--text-muted);
  width: 50px;
  flex-shrink: 0;
}

.cp-slider input[type="range"] {
  flex: 1;
  min-width: 0;
  height: 4px;
  -webkit-appearance: none;
  background: var(--bg-input);
  border-radius: 2px;
}

.cp-slider input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  background: white;
  border-radius: 50%;
  cursor: pointer;
}

.cp-slider .cc-value {
  width: 35px;
  flex-shrink: 0;
  text-align: right;
}

/* === HUE / SATURATION VISUAL CONTROL === */
.hue-sat-control {
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  padding: var(--spacing-md);
  min-width: 220px;
  flex: 1;
}

.hs-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
}

.hs-header span {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.hs-sliders {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.hs-slider {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.hs-slider label {
  font-size: 10px;
  color: var(--text-muted);
  width: 60px;
}

.hue-track-container,
.sat-track-container {
  position: relative;
  flex: 1;
  height: 18px;
  border-radius: 9px;
  overflow: hidden;
}

.hue-gradient {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(to right, 
    hsl(180, 60%, 50%),
    hsl(240, 60%, 50%),
    hsl(300, 60%, 50%),
    hsl(360, 60%, 50%),
    hsl(60, 60%, 50%),
    hsl(120, 60%, 50%),
    hsl(180, 60%, 50%)
  );
  border-radius: 9px;
}

.sat-gradient {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(to right, 
    #666666 0%,
    #ff6666 50%,
    #ff0000 100%
  );
  border-radius: 9px;
}

.hue-slider,
.sat-slider {
  position: relative;
  z-index: 2;
  width: 100%;
  height: 18px;
  -webkit-appearance: none;
  background: transparent;
}

.hue-slider::-webkit-slider-thumb,
.sat-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: white;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 1px 4px rgba(0,0,0,0.4), 0 0 0 2px rgba(0,0,0,0.1);
}

/* === LUM MIX CONTROL === */
.lummix-row {
  display: flex;
  justify-content: center;
  padding: 12px 0;
  border-top: 1px solid var(--border-color);
  margin-top: 8px;
}

.lummix-control-centered {
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 300px;
  width: 100%;
}

.lummix-control-centered label {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-secondary);
  white-space: nowrap;
}

.lummix-control-centered input[type="range"] {
  flex: 1;
  height: 4px;
  -webkit-appearance: none;
  background: var(--bg-tertiary);
  border-radius: 2px;
}

.lummix-control-centered input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: white;
  border-radius: 50%;
  cursor: pointer;
}

.lummix-control-centered .cc-value {
  min-width: 36px;
}

.lummix-control-centered .mini-reset {
  padding: 2px 6px;
}

.lummix-control {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 100px;
}

.lummix-control label {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-secondary);
}

.lummix-control input[type="range"] {
  height: 4px;
  -webkit-appearance: none;
  background: var(--bg-tertiary);
  border-radius: 2px;
}

.lummix-control input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  background: white;
  border-radius: 50%;
  cursor: pointer;
}

.cc-value {
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--accent-blue);
  text-align: right;
}

/* === PTZ JOYSTICK === */
.joystick-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-sm);
  width: 150px;
}

.joystick {
  width: 150px;
  height: 150px;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-color);
  border-radius: 50%;
  position: relative;
  cursor: crosshair;
}

.joystick::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 1px;
  background: var(--border-color);
}

.joystick::after {
  content: '';
  position: absolute;
  left: 50%;
  top: 0;
  bottom: 0;
  width: 1px;
  background: var(--border-color);
}

.joystick-handle {
  position: absolute;
  width: 30px;
  height: 30px;
  background: var(--accent-blue);
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  pointer-events: none;
}

.joystick-labels {
  display: flex;
  justify-content: center;
  gap: var(--spacing-lg);
  width: 100%;
  font-size: 10px;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
}

/* === MEMORY PRESETS === */
.memory-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-sm);
}

.memory-btn {
  padding: var(--spacing-md);
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
}

.memory-btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.memory-btn.active {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

/* === PTZ LAYOUT === */
.ptz-layout {
  display: flex;
  gap: var(--spacing-xl);
  align-items: flex-start;
  flex-wrap: wrap;
}

.ptz-joystick-section {
  flex: 0 0 auto;
}

.ptz-presets-section {
  flex: 1;
  min-width: 200px;
  max-width: 300px;
}

.ptz-presets-section .section-label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: var(--spacing-sm);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.memory-actions {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
}

.memory-action-btn {
  flex: 1;
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
}

.memory-action-btn.recall {
  background: var(--accent-green);
  color: white;
}

.memory-action-btn.save {
  background: var(--accent-orange);
  color: white;
}

.memory-action-btn.reset {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}

/* === SAVE STATUS === */
.save-status {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: var(--spacing-xl) 30px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  z-index: 9999;
  text-align: center;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}

.save-status .progress {
  margin-top: var(--spacing-md);
  height: 4px;
  background: var(--bg-tertiary);
  border-radius: 2px;
  overflow: hidden;
}

.save-status .progress-bar {
  height: 100%;
  background: var(--accent-blue);
  transition: width 0.3s ease;
}

.save-status.success { border-color: var(--accent-green); }
.save-status.error { border-color: var(--accent-red); }

/* === RESPONSIVE === */
@media (max-width: 1200px) {
  .color-wheels-row {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .header {
    flex-direction: column;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
  }
  
  .camera-strip {
    padding: var(--spacing-xs) var(--spacing-sm);
    gap: 4px;
  }
  
  .camera-btn {
    min-width: 32px;
    padding: 6px 8px;
    font-size: 11px;
  }
  
  .camera-btn .cam-prefix {
    display: none;
  }
  
  .toolbar {
    flex-direction: column;
  }
  
  .control-row {
    justify-content: center;
  }
  
  .color-wheels-row {
    grid-template-columns: repeat(2, 1fr);
    padding: var(--spacing-md);
  }
  
  .color-wheel {
    width: 90px;
    height: 90px;
  }
}
</style>
</head>
<body>
<script>
// Early initialization of global variables
let multiSubValues = {};
</script>

<!-- HEADER -->
<header class="header">
  <div class="header-left">
    <div class="logo">Tally<span class="logo-accent">CCU</span> Pro</div>
    <span class="logo-sub">SDI Blackmagic Camera Control</span>
  </div>
  <nav class="header-nav">
    <button class="nav-btn" onclick="location.href='tally.html'">üì∫ Tally Map</button>
    <button class="nav-btn" onclick="location.href='/sd'">üìÅ SD Card</button>
  </nav>
</header>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="toolbar-group">
    <span class="toolbar-label">Override:</span>
    <button id="btnTally" class="toolbar-btn active" onclick="toggleOverrideTally()">Tally <span class="status">On</span></button>
    <button id="btnCCU" class="toolbar-btn active" onclick="toggleOverrideCCU()">CCU <span class="status">On</span></button>
    <button id="btnVmix" class="toolbar-btn active" onclick="toggleVmixConnect()">vMix <span class="status">On</span></button>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn danger" onclick="rebootArduino()">‚ü≥ Reboot</button>
  </div>
</div>

<!-- CAMERA SELECTOR -->
<div class="camera-strip">
  <button id="camBtn1" class="camera-btn" onclick="setCameraId(1)"><span class="cam-prefix">CAM </span>1</button>
  <button id="camBtn2" class="camera-btn" onclick="setCameraId(2)"><span class="cam-prefix">CAM </span>2</button>
  <button id="camBtn3" class="camera-btn" onclick="setCameraId(3)"><span class="cam-prefix">CAM </span>3</button>
  <button id="camBtn4" class="camera-btn" onclick="setCameraId(4)"><span class="cam-prefix">CAM </span>4</button>
  <button id="camBtn5" class="camera-btn" onclick="setCameraId(5)"><span class="cam-prefix">CAM </span>5</button>
  <button id="camBtn6" class="camera-btn" onclick="setCameraId(6)"><span class="cam-prefix">CAM </span>6</button>
  <button id="camBtn7" class="camera-btn" onclick="setCameraId(7)"><span class="cam-prefix">CAM </span>7</button>
  <button id="camBtn8" class="camera-btn" onclick="setCameraId(8)"><span class="cam-prefix">CAM </span>8</button>
</div>

<!-- PRESETS PANEL (Slide-out) -->
<button class="presets-toggle" id="presetsToggle" onclick="togglePresetsPanel()">‚ò∞ Presets</button>

<div class="presets-panel" id="presetsPanel">
  <div class="presets-panel-header">
    <span class="presets-panel-title">‚öôÔ∏è Presets & Groups</span>
    <button class="presets-panel-close" onclick="togglePresetsPanel()">‚úï</button>
  </div>
  
  <!-- Group Selectors Section -->
  <div class="presets-section">
    <div class="presets-section-title">Parameter Groups</div>
    <div class="group-chips">
      <label class="group-chip"><input type="checkbox" id="group_selector_lens" onchange="toggleParamGroup('lens')" checked><span>Lens</span></label>
      <label class="group-chip"><input type="checkbox" id="group_selector_video" onchange="toggleParamGroup('video')" checked><span>Video</span></label>
      <label class="group-chip"><input type="checkbox" id="group_selector_color_correction" onchange="toggleParamGroup('color_correction')" checked><span>Color</span></label>
      <label class="group-chip"><input type="checkbox" id="group_selector_output" onchange="toggleParamGroup('output')"><span>Output</span></label>
      <label class="group-chip"><input type="checkbox" id="group_selector_display" onchange="toggleParamGroup('display')"><span>Display</span></label>
      <label class="group-chip"><input type="checkbox" id="group_selector_audio" onchange="toggleParamGroup('audio')"><span>Audio</span></label>
      <label class="group-chip"><input type="checkbox" id="group_selector_tally" onchange="toggleParamGroup('tally')"><span>Tally</span></label>
      <label class="group-chip"><input type="checkbox" id="group_selector_reference" onchange="toggleParamGroup('reference')"><span>Reference</span></label>
      <label class="group-chip"><input type="checkbox" id="group_selector_ptz_control" onchange="toggleParamGroup('ptz_control')"><span>PTZ</span></label>
    </div>
    <div class="group-actions">
      <button class="group-action-btn" onclick="toggleAllParamGroups(true)">Select All</button>
      <button class="group-action-btn" onclick="setDefaultParamGroups()">Default</button>
    </div>
  </div>
  
  <!-- Presets Section -->
  <div class="presets-section">
    <div class="presets-section-title">Camera Presets</div>
  </div>
  
  <div class="presets-list">
    <div class="preset-card">
      <div class="preset-card-header">
        <span class="preset-card-number">1</span>
        <input type="text" id="presetName_0" class="preset-name" value="Preset 1">
      </div>
      <div class="preset-card-actions">
        <button class="preset-card-btn save" onclick="savePreset(0)">Save</button>
        <button class="preset-card-btn load" onclick="loadPreset(0)">Load</button>
      </div>
    </div>
    
    <div class="preset-card">
      <div class="preset-card-header">
        <span class="preset-card-number">2</span>
        <input type="text" id="presetName_1" class="preset-name" value="Preset 2">
      </div>
      <div class="preset-card-actions">
        <button class="preset-card-btn save" onclick="savePreset(1)">Save</button>
        <button class="preset-card-btn load" onclick="loadPreset(1)">Load</button>
      </div>
    </div>
    
    <div class="preset-card">
      <div class="preset-card-header">
        <span class="preset-card-number">3</span>
        <input type="text" id="presetName_2" class="preset-name" value="Preset 3">
      </div>
      <div class="preset-card-actions">
        <button class="preset-card-btn save" onclick="savePreset(2)">Save</button>
        <button class="preset-card-btn load" onclick="loadPreset(2)">Load</button>
      </div>
    </div>
    
    <div class="preset-card">
      <div class="preset-card-header">
        <span class="preset-card-number">4</span>
        <input type="text" id="presetName_3" class="preset-name" value="Preset 4">
      </div>
      <div class="preset-card-actions">
        <button class="preset-card-btn save" onclick="savePreset(3)">Save</button>
        <button class="preset-card-btn load" onclick="loadPreset(3)">Load</button>
      </div>
    </div>
    
    <div class="preset-card">
      <div class="preset-card-header">
        <span class="preset-card-number">5</span>
        <input type="text" id="presetName_4" class="preset-name" value="Preset 5">
      </div>
      <div class="preset-card-actions">
        <button class="preset-card-btn save" onclick="savePreset(4)">Save</button>
        <button class="preset-card-btn load" onclick="loadPreset(4)">Load</button>
      </div>
    </div>
  </div>
  
  <div class="presets-panel-footer">
    <button class="preset-reset-btn" onclick="resetSelectedGroupParams()">‚ü≥ Reset to Defaults</button>
  </div>
</div>

<!-- TABS SIDEBAR + MAIN CONTENT WRAPPER -->
<div class="app-layout">
  
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <span class="sidebar-title">Parameter Groups</span>
      <nav class="sidebar-nav">
        <button class="sidebar-tab" onclick="showTab('group_lens')"><span class="tab-icon">üî≠</span><span class="tab-text">Lens</span></button>
        <button class="sidebar-tab" onclick="showTab('group_video')"><span class="tab-icon">üé¨</span><span class="tab-text">Video</span></button>
        <button class="sidebar-tab" onclick="showTab('group_color_correction')"><span class="tab-icon">üé®</span><span class="tab-text">Color</span></button>
        <button class="sidebar-tab" onclick="showTab('group_output')"><span class="tab-icon">üìê</span><span class="tab-text">Output</span></button>
        <button class="sidebar-tab" onclick="showTab('group_display')"><span class="tab-icon">üñ•Ô∏è</span><span class="tab-text">Display</span></button>
        <button class="sidebar-tab" onclick="showTab('group_audio')"><span class="tab-icon">üîä</span><span class="tab-text">Audio</span></button>
        <button class="sidebar-tab" onclick="showTab('group_tally')"><span class="tab-icon">üî¥</span><span class="tab-text">Tally</span></button>
        <button class="sidebar-tab" onclick="showTab('group_reference')"><span class="tab-icon">‚è±Ô∏è</span><span class="tab-text">Reference</span></button>
        <button class="sidebar-tab" onclick="showTab('group_ptz_control')"><span class="tab-icon">üïπÔ∏è</span><span class="tab-text">PTZ</span></button>
      </nav>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">

  <!-- ===== LENS TAB ===== -->
  <div id="group_lens" class="tabcontent">
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üî≠ Lens Control</span>
      </div>
      <div class="control-panel-body">
        <div class="control-row">
          
          <div class="knob-control">
            <label>Aperture</label>
            <div class="knob-container">
              <div class="knob-with-buttons">
                <button class="knob-pm-btn" onclick="adjustKnob('aperture', -1)">‚àí</button>
                <div class="knob" id="knob-aperture" data-min="0" data-max="1" data-value="0.5" data-param="aperture_normalised">
                  <div class="knob-track"></div>
                  <div class="knob-indicator"></div>
                </div>
                <button class="knob-pm-btn" onclick="adjustKnob('aperture', 1)">+</button>
              </div>
              <input type="number" class="knob-input param-control" id="aperture_normalised_input" 
                data-paramkey="aperture_normalised" data-paramtype="range" data-default="0"
                value="0.00" min="0" max="1" step="0.05">
            </div>
            <div class="knob-presets">
              <button onclick="setKnobValue('aperture', 0)">Min</button>
              <button onclick="setKnobValue('aperture', 0.5)">Mid</button>
              <button onclick="setKnobValue('aperture', 1)">Max</button>
              <button class="auto-btn" onclick="triggerVoid('instantaneous_auto_aperture')">Auto</button>
            </div>
          </div>
          
          <div class="knob-control">
            <label>Focus</label>
            <div class="knob-container">
              <div class="knob-with-buttons">
                <button class="knob-pm-btn" onclick="adjustKnob('focus', -1)">‚àí</button>
                <div class="knob" id="knob-focus" data-min="0" data-max="1" data-value="0" data-param="focus">
                  <div class="knob-track"></div>
                  <div class="knob-indicator"></div>
                </div>
                <button class="knob-pm-btn" onclick="adjustKnob('focus', 1)">+</button>
              </div>
              <input type="number" class="knob-input param-control" id="focus_input"
                data-paramkey="focus" data-paramtype="range" data-default="0"
                value="0.00" min="0" max="1" step="0.05">
            </div>
            <div class="knob-presets">
              <button onclick="setKnobValue('focus', 0)">Near</button>
              <button onclick="setKnobValue('focus', 0.5)">Mid</button>
              <button onclick="setKnobValue('focus', 1)">Far</button>
              <button class="auto-btn" onclick="triggerVoid('instantaneous_autofocus')">Auto</button>
            </div>
          </div>
          
          <div class="knob-control">
            <label>Zoom</label>
            <div class="knob-container">
              <div class="knob-with-buttons">
                <button class="knob-pm-btn" onclick="adjustKnob('zoom', -1)">‚àí</button>
                <div class="knob" id="knob-zoom" data-min="0" data-max="1" data-value="0" data-param="set_absolute_zoom_normalised">
                  <div class="knob-track"></div>
                  <div class="knob-indicator"></div>
                </div>
                <button class="knob-pm-btn" onclick="adjustKnob('zoom', 1)">+</button>
              </div>
              <input type="number" class="knob-input param-control" id="set_absolute_zoom_normalised_input"
                data-paramkey="set_absolute_zoom_normalised" data-paramtype="range" data-default="0"
                value="0.00" min="0" max="1" step="0.05">
            </div>
            <div class="knob-presets">
              <button onclick="setKnobValue('zoom', 0)">Wide</button>
              <button onclick="setKnobValue('zoom', 0.5)">Mid</button>
              <button onclick="setKnobValue('zoom', 1)">Tele</button>
            </div>
          </div>
          
        </div>
      </div>
    </div>
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">‚ö° Continuous Zoom & Options</span>
      </div>
      <div class="control-panel-body">
        <div class="slider-row">
          <div class="slider-control wide">
            <div class="slider-header">
              <label>Continuous Zoom Speed</label>
              <input type="number" class="slider-input param-control" id="set_continuous_zoom_speed_input"
                data-paramkey="set_continuous_zoom_speed" data-paramtype="range" data-default="0"
                value="0" min="-1" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="set_continuous_zoom_speed_range"
              data-paramkey="set_continuous_zoom_speed" data-paramtype="range"
              min="-1" max="1" step="0.1" value="0" data-default="0"
              oninput="continuousSliderInput('set_continuous_zoom_speed', this)"
              onchange="continuousSliderRelease('set_continuous_zoom_speed', this)">
            <div class="slider-labels">
              <span>‚Üê Wide</span>
              <span>Stop</span>
              <span>Tele ‚Üí</span>
            </div>
          </div>
          
          <div class="setting-item">
            <label>Image Stabilisation</label>
            <label class="switch">
              <input type="checkbox" class="param-control" id="optical_image_stabilisation_check"
                data-paramkey="optical_image_stabilisation" data-paramtype="checkbox" data-default="1"
                onchange="toggleCheckbox('optical_image_stabilisation', this)" checked>
              <span class="switch-slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>
    
  </div>

  <!-- ===== VIDEO TAB ===== -->
  <div id="group_video" class="tabcontent">
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üì∑ Exposure</span>
      </div>
      <div class="control-panel-body">
        <div class="control-row">
          
          <div class="knob-control">
            <label>Shutter</label>
            <div class="knob-container">
              <div class="knob-with-buttons">
                <button class="knob-pm-btn" onclick="adjustKnob('shutter', -1)">‚àí</button>
                <div class="knob" id="knob-shutter" data-min="24" data-max="2000" data-value="50" data-param="shutter_speed">
                  <div class="knob-track"></div>
                  <div class="knob-indicator"></div>
                </div>
                <button class="knob-pm-btn" onclick="adjustKnob('shutter', 1)">+</button>
              </div>
              <input type="number" class="knob-input param-control" id="shutter_speed_input"
                data-paramkey="shutter_speed" data-paramtype="range" data-default="24"
                value="24" min="24" max="2000" step="1">
            </div>
            <div class="knob-presets" id="shutter-presets">
              <button onclick="setShutterToFrameRate()">1/60</button>
              <button onclick="setShutterDouble()">1/120</button>
              <button onclick="setShutterQuadruple()">1/240</button>
            </div>
          </div>
          
          <div class="knob-control">
            <label>Gain (dB)</label>
            <div class="knob-container">
              <div class="knob-with-buttons">
                <button class="knob-pm-btn" onclick="adjustKnob('gain', -1)">‚àí</button>
                <div class="knob" id="knob-gain" data-min="-12" data-max="32" data-value="0" data-param="gain_db">
                  <div class="knob-track"></div>
                  <div class="knob-indicator"></div>
                </div>
                <button class="knob-pm-btn" onclick="adjustKnob('gain', 1)">+</button>
              </div>
              <input type="number" class="knob-input param-control" id="gain_db_input"
                data-paramkey="gain_db" data-paramtype="range" data-default="0"
                value="0" min="-12" max="32" step="2">
            </div>
            <div class="knob-presets">
              <button onclick="setKnobValue('gain', 0)">0</button>
              <button onclick="setKnobValue('gain', 6)">+6</button>
              <button onclick="setKnobValue('gain', 12)">+12</button>
              <button onclick="setKnobValue('gain', 18)">+18</button>
            </div>
          </div>
          
          <div class="knob-control">
            <label>ND Filter</label>
            <div class="knob-container">
              <div class="knob-with-buttons">
                <button class="knob-pm-btn" onclick="adjustKnob('nd', -1)">‚àí</button>
                <div class="knob" id="knob-nd" data-min="0" data-max="6" data-value="0" data-param="nd_filter_stop">
                  <div class="knob-track"></div>
                  <div class="knob-indicator"></div>
                </div>
                <button class="knob-pm-btn" onclick="adjustKnob('nd', 1)">+</button>
              </div>
              <input type="number" class="knob-input param-control" id="nd_filter_stop_0_input"
                data-paramkey="nd_filter_stop" data-paramtype="sub-range" data-subindex="0" data-default="0"
                value="0" min="0" max="6" step="1">
            </div>
            <div class="knob-presets">
              <button onclick="setKnobValue('nd', 0)">Clear</button>
              <button onclick="setKnobValue('nd', 2)">ND2</button>
              <button onclick="setKnobValue('nd', 4)">ND4</button>
            </div>
            <div class="nd-mode-mini">
              <button class="nd-mode-btn active" data-value="0" onclick="setNdDisplayMode(0, this)">Stop</button>
              <button class="nd-mode-btn" data-value="1" onclick="setNdDisplayMode(1, this)">Dens</button>
              <button class="nd-mode-btn" data-value="2" onclick="setNdDisplayMode(2, this)">Trans</button>
            </div>
          </div>
          
        </div>
        <script>multiSubValues["nd_filter_stop"] = [0, 0];</script>
      </div>
    </div>
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üå°Ô∏è White Balance</span>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:11px;color:var(--text-secondary);">Auto WB</span>
          <label class="switch">
            <input type="checkbox" id="auto_wb_toggle" onchange="toggleAutoWB(this)">
            <span class="switch-slider"></span>
          </label>
        </div>
      </div>
      <div class="control-panel-body">
        <div class="slider-row">
          <div class="slider-control wide">
            <div class="slider-header">
              <label>Color Temperature</label>
              <button class="slider-reset" onclick="resetSubSlider('manual_white_balance', 0)">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="manual_white_balance_0_input"
                data-paramkey="manual_white_balance" data-paramtype="sub-range" data-subindex="0" data-default="5600"
                value="5600" min="2500" max="10000" step="100">
              <span class="slider-unit">K</span>
            </div>
            <div class="slider-track-container">
              <div class="slider-gradient temp-gradient"></div>
              <input type="range" id="manual_white_balance_0_range" class="styled-slider has-gradient param-control"
                data-paramkey="manual_white_balance" data-paramtype="sub-range" data-subindex="0"
                min="2500" max="10000" step="100" value="5600" data-default="5600"
                oninput="styledSliderInput('manual_white_balance', 0, this)"
                onchange="multiSubOnChange('manual_white_balance')">
            </div>
            <div class="slider-labels"><span>2500K</span><span>6250K</span><span>10000K</span></div>
          </div>
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Tint</label>
              <button class="slider-reset" onclick="resetSubSlider('manual_white_balance', 1)">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="manual_white_balance_1_input"
                data-paramkey="manual_white_balance" data-paramtype="sub-range" data-subindex="1" data-default="10"
                value="10" min="-50" max="50" step="1">
            </div>
            <div class="slider-track-container">
              <div class="slider-gradient tint-gradient"></div>
              <input type="range" id="manual_white_balance_1_range" class="styled-slider has-gradient param-control"
                data-paramkey="manual_white_balance" data-paramtype="sub-range" data-subindex="1"
                min="-50" max="50" step="1" value="10" data-default="10"
                oninput="styledSliderInput('manual_white_balance', 1, this)"
                onchange="multiSubOnChange('manual_white_balance')">
            </div>
            <div class="slider-labels"><span>Green</span><span>Magenta</span></div>
          </div>
        </div>
        <script>multiSubValues["manual_white_balance"] = [5600, 10];</script>
      </div>
    </div>
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">‚öôÔ∏è Video Settings</span>
      </div>
      <div class="control-panel-body">
        <div class="settings-grid">
          
          <div class="setting-item">
            <label>Dynamic Range</label>
            <div class="toggle-group" id="toggle-dynamic_range_mode">
              <button class="toggle-btn" data-value="0" onclick="setToggleValue('dynamic_range_mode', 0, this)">Film</button>
              <button class="toggle-btn" data-value="1" onclick="setToggleValue('dynamic_range_mode', 1, this)">Video</button>
              <button class="toggle-btn active" data-value="2" onclick="setToggleValue('dynamic_range_mode', 2, this)">Ext Video</button>
            </div>
            <input type="hidden" id="dynamic_range_mode_range" class="param-control"
              data-paramkey="dynamic_range_mode" data-paramtype="range" data-default="2" value="2">
          </div>
          
          <div class="setting-item">
            <label>Sharpening</label>
            <div class="toggle-group" id="toggle-video_sharpening_level">
              <button class="toggle-btn active" data-value="0" onclick="setToggleValue('video_sharpening_level', 0, this)">Off</button>
              <button class="toggle-btn" data-value="1" onclick="setToggleValue('video_sharpening_level', 1, this)">Low</button>
              <button class="toggle-btn" data-value="2" onclick="setToggleValue('video_sharpening_level', 2, this)">Med</button>
              <button class="toggle-btn" data-value="3" onclick="setToggleValue('video_sharpening_level', 3, this)">High</button>
            </div>
            <input type="hidden" id="video_sharpening_level_range" class="param-control"
              data-paramkey="video_sharpening_level" data-paramtype="range" data-default="0" value="0">
          </div>
          
          <div class="setting-item">
            <label>Auto Exposure</label>
            <div class="toggle-group" id="toggle-set_auto_exposure_mode">
              <button class="toggle-btn active" data-value="0" onclick="setToggleValue('set_auto_exposure_mode', 0, this)">Manual</button>
              <button class="toggle-btn" data-value="1" onclick="setToggleValue('set_auto_exposure_mode', 1, this)">Iris</button>
              <button class="toggle-btn" data-value="2" onclick="setToggleValue('set_auto_exposure_mode', 2, this)">Shutter</button>
              <button class="toggle-btn" data-value="3" onclick="setToggleValue('set_auto_exposure_mode', 3, this)">Iris+Sh</button>
              <button class="toggle-btn" data-value="4" onclick="setToggleValue('set_auto_exposure_mode', 4, this)">Sh+Iris</button>
            </div>
            <input type="hidden" id="set_auto_exposure_mode_range" class="param-control"
              data-paramkey="set_auto_exposure_mode" data-paramtype="range" data-default="0" value="0">
          </div>
          
          <div class="setting-item">
            <label>Display LUT</label>
            <div style="display:flex; gap:var(--spacing-sm); align-items:center;">
              <select class="styled-select param-control" id="display_lut_0_select" style="flex:1;"
                data-paramkey="display_lut" data-paramtype="select" data-subindex="0" data-default="0"
                onchange="multiSubSelectChange('display_lut', 0, this)">
                <option value="0" selected>None</option>
                <option value="1">Custom</option>
                <option value="2">Film to Video</option>
                <option value="3">Film to Ext Video</option>
              </select>
              <label class="switch">
                <input type="checkbox" class="param-control" id="display_lut_1_check"
                  data-paramkey="display_lut" data-paramtype="sub-check" data-subindex="1" data-default="0"
                  onchange="multiSubCheckChange('display_lut', 1, this)">
                <span class="switch-slider"></span>
              </label>
            </div>
          </div>
          <script>multiSubValues["display_lut"] = [0, 0];</script>
          
        </div>
      </div>
    </div>
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üé¨ Video Mode</span>
      </div>
      <div class="control-panel-body">
        <div class="settings-grid">
          
          <div class="setting-item">
            <label>Resolution</label>
            <select class="styled-select param-control" id="video_mode_2_select"
              data-paramkey="video_mode" data-paramtype="select" data-subindex="2" data-default="6"
              onchange="multiSubSelectChange('video_mode', 2, this)">
              <option value="0">NTSC</option>
              <option value="1">PAL</option>
              <option value="2">720p</option>
              <option value="3">1080p</option>
              <option value="4">2K DCI</option>
              <option value="5">2K 16:9</option>
              <option value="6" selected>UHD</option>
              <option value="7">3K Anamorphic</option>
              <option value="8">4K DCI</option>
              <option value="9">4K 16:9</option>
              <option value="10">4.6K 2.4:1</option>
              <option value="11">4.6K</option>
            </select>
          </div>
          
          <div class="setting-item">
            <label>Frame Rate</label>
            <div class="toggle-group" id="toggle-video_mode_0">
              <button class="toggle-btn" data-value="24" onclick="setVideoModeValue(0, 24, this)">24</button>
              <button class="toggle-btn" data-value="25" onclick="setVideoModeValue(0, 25, this)">25</button>
              <button class="toggle-btn" data-value="30" onclick="setVideoModeValue(0, 30, this)">30</button>
              <button class="toggle-btn" data-value="50" onclick="setVideoModeValue(0, 50, this)">50</button>
              <button class="toggle-btn active" data-value="60" onclick="setVideoModeValue(0, 60, this)">60</button>
            </div>
            <input type="hidden" id="video_mode_0_range" class="param-control" data-paramkey="video_mode" data-paramtype="sub-range" data-subindex="0" value="60" data-default="60">
          </div>
          
          <div class="setting-item">
            <label>M-Rate</label>
            <div class="toggle-group" id="toggle-video_mode_1">
              <button class="toggle-btn active" data-value="0" onclick="setVideoModeValue(1, 0, this)">Regular</button>
              <button class="toggle-btn" data-value="1" onclick="setVideoModeValue(1, 1, this)">M-Rate</button>
            </div>
            <input type="hidden" id="video_mode_1_range" class="param-control" data-paramkey="video_mode" data-paramtype="sub-range" data-subindex="1" value="0" data-default="0">
          </div>
          
          <div class="setting-item">
            <label>Scan Mode</label>
            <div class="toggle-group" id="toggle-video_mode_3">
              <button class="toggle-btn active" data-value="0" onclick="setVideoModeValue(3, 0, this)">Progressive</button>
              <button class="toggle-btn" data-value="1" onclick="setVideoModeValue(3, 1, this)">Interlaced</button>
            </div>
            <input type="hidden" id="video_mode_3_range" class="param-control" data-paramkey="video_mode" data-paramtype="sub-range" data-subindex="3" value="0" data-default="0">
          </div>
          
        </div>
        <script>multiSubValues["video_mode"] = [60, 0, 6, 0, 0];</script>
        <input type="hidden" id="video_mode_4_range" class="param-control" data-paramkey="video_mode" data-paramtype="sub-range" data-subindex="4" value="0" data-default="0">
      </div>
    </div>
    
  </div>

  <!-- ===== COLOR CORRECTION TAB ===== -->
  <div id="group_color_correction" class="tabcontent">
    
    <div class="color-panel">
      <div class="color-panel-header">
        <span class="color-panel-title">üé® Primary Color Corrector</span>
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:10px;color:var(--text-muted);">Range:</span>
          <div class="toggle-group" id="wheel-range-selector" style="margin:0;">
            <button class="toggle-btn" data-value="0.25" onclick="setWheelRange(0.25, this)">Fine</button>
            <button class="toggle-btn active" data-value="0.5" onclick="setWheelRange(0.5, this)">Normal</button>
            <button class="toggle-btn" data-value="1" onclick="setWheelRange(1, this)">Full</button>
          </div>
          <button class="color-panel-btn" onclick="resetAllColorWheels()">‚ü≥ Reset All</button>
        </div>
      </div>
      
      <div class="color-wheels-row">
        <div class="color-wheel-group">
          <div class="wheel-header">
            <span class="wheel-title lift">LIFT</span>
            <button class="wheel-reset" onclick="resetSingleWheel('lift')">‚ü≥</button>
          </div>
          <div class="color-wheel" id="wheel-lift" data-wheel="lift">
            <div class="wheel-center"></div>
            <div class="wheel-pointer" id="pointer-lift"></div>
          </div>
          <div class="wheel-master">
            <input type="range" class="master-slider lift" min="-2" max="2" step="0.01" value="0" id="lift-master"
              oninput="updateWheelMaster('lift', this.value)">
          </div>
          <div class="wheel-values">
            <div class="wheel-value"><label class="r">R</label><input type="text" id="lift-r" value="0.00" readonly></div>
            <div class="wheel-value"><label class="g">G</label><input type="text" id="lift-g" value="0.00" readonly></div>
            <div class="wheel-value"><label class="b">B</label><input type="text" id="lift-b" value="0.00" readonly></div>
            <div class="wheel-value"><label class="y">Y</label><input type="text" id="lift-y" value="0.00" readonly></div>
          </div>
        </div>
        
        <div class="color-wheel-group">
          <div class="wheel-header">
            <span class="wheel-title gamma">GAMMA</span>
            <button class="wheel-reset" onclick="resetSingleWheel('gamma')">‚ü≥</button>
          </div>
          <div class="color-wheel" id="wheel-gamma" data-wheel="gamma">
            <div class="wheel-center"></div>
            <div class="wheel-pointer" id="pointer-gamma"></div>
          </div>
          <div class="wheel-master">
            <input type="range" class="master-slider gamma" min="-4" max="4" step="0.01" value="0" id="gamma-master"
              oninput="updateWheelMaster('gamma', this.value)">
          </div>
          <div class="wheel-values">
            <div class="wheel-value"><label class="r">R</label><input type="text" id="gamma-r" value="0.00" readonly></div>
            <div class="wheel-value"><label class="g">G</label><input type="text" id="gamma-g" value="0.00" readonly></div>
            <div class="wheel-value"><label class="b">B</label><input type="text" id="gamma-b" value="0.00" readonly></div>
            <div class="wheel-value"><label class="y">Y</label><input type="text" id="gamma-y" value="0.00" readonly></div>
          </div>
        </div>
        
        <div class="color-wheel-group">
          <div class="wheel-header">
            <span class="wheel-title gain">GAIN</span>
            <button class="wheel-reset" onclick="resetSingleWheel('gain')">‚ü≥</button>
          </div>
          <div class="color-wheel" id="wheel-gain" data-wheel="gain">
            <div class="wheel-center"></div>
            <div class="wheel-pointer" id="pointer-gain"></div>
          </div>
          <div class="wheel-master">
            <input type="range" class="master-slider gain" min="0" max="16" step="0.01" value="1" id="gain-master"
              oninput="updateWheelMaster('gain', this.value)">
          </div>
          <div class="wheel-values">
            <div class="wheel-value"><label class="r">R</label><input type="text" id="gain-r" value="1.00" readonly></div>
            <div class="wheel-value"><label class="g">G</label><input type="text" id="gain-g" value="1.00" readonly></div>
            <div class="wheel-value"><label class="b">B</label><input type="text" id="gain-b" value="1.00" readonly></div>
            <div class="wheel-value"><label class="y">Y</label><input type="text" id="gain-y" value="1.00" readonly></div>
          </div>
        </div>
        
        <div class="color-wheel-group">
          <div class="wheel-header">
            <span class="wheel-title offset">OFFSET</span>
            <button class="wheel-reset" onclick="resetSingleWheel('offset')">‚ü≥</button>
          </div>
          <div class="color-wheel" id="wheel-offset" data-wheel="offset">
            <div class="wheel-center"></div>
            <div class="wheel-pointer" id="pointer-offset"></div>
          </div>
          <div class="wheel-master">
            <input type="range" class="master-slider offset" min="-8" max="8" step="0.01" value="0" id="offset-master"
              oninput="updateWheelMaster('offset', this.value)">
          </div>
          <div class="wheel-values">
            <div class="wheel-value"><label class="r">R</label><input type="text" id="offset-r" value="0.00" readonly></div>
            <div class="wheel-value"><label class="g">G</label><input type="text" id="offset-g" value="0.00" readonly></div>
            <div class="wheel-value"><label class="b">B</label><input type="text" id="offset-b" value="0.00" readonly></div>
            <div class="wheel-value"><label class="y">Y</label><input type="text" id="offset-y" value="0.00" readonly></div>
          </div>
        </div>
      </div>
      
      <!-- LUM MIX - Centered below wheels -->
      <div class="lummix-row">
        <div class="lummix-control-centered">
          <label>Lum Mix</label>
          <input type="range" min="0" max="1" step="0.01" value="1" id="cc-lummix"
            oninput="updateLumMix(this.value)" onchange="sendLumMix()">
          <span class="cc-value" id="cc-lummix-val">1.00</span>
          <button class="mini-reset" onclick="resetLumMix()">‚ü≥</button>
        </div>
      </div>
      
      <div class="color-controls-row">
        <!-- CONTRAST / PIVOT - Visual curve control -->
        <div class="contrast-pivot-control">
          <div class="cp-header">
            <span>Contrast / Pivot</span>
            <button class="mini-reset" onclick="resetContrastPivot()">‚ü≥</button>
          </div>
          <div class="cp-visual">
            <svg class="contrast-curve" viewBox="0 0 100 100" preserveAspectRatio="none">
              <line x1="0" y1="100" x2="100" y2="0" stroke="#333" stroke-width="1"/>
              <path id="contrast-curve-path" d="M 0,100 Q 25,75 50,50 Q 75,25 100,0" stroke="#4a90d9" stroke-width="2" fill="none"/>
            </svg>
            <div id="pivot-point" class="pivot-marker"></div>
          </div>
          <div class="cp-sliders">
            <div class="cp-slider">
              <label>Contrast</label>
              <input type="range" min="0" max="2" step="0.01" value="1" id="cc-contrast"
                oninput="updateContrastPivot()" onchange="sendContrastPivot()" ontouchend="sendContrastPivot()">
              <span class="cc-value" id="cc-contrast-val">1.00</span>
            </div>
            <div class="cp-slider">
              <label>Pivot</label>
              <input type="range" min="0" max="1" step="0.01" value="0.5" id="cc-pivot"
                oninput="updateContrastPivot()" onchange="sendContrastPivot()" ontouchend="sendContrastPivot()">
              <span class="cc-value" id="cc-pivot-val">0.50</span>
            </div>
          </div>
        </div>
        
        <!-- HUE / SATURATION - Visual color control -->
        <div class="hue-sat-control">
          <div class="hs-header">
            <span>Hue / Saturation</span>
            <button class="mini-reset" onclick="resetHueSat()">‚ü≥</button>
          </div>
          <div class="hs-sliders">
            <div class="hs-slider">
              <label>Hue</label>
              <div class="hue-track-container">
                <div class="hue-gradient"></div>
                <input type="range" class="hue-slider" min="-1" max="1" step="0.01" value="0" id="cc-hue"
                  oninput="updateHueSat()" onchange="sendHueSat()" ontouchend="sendHueSat()">
              </div>
              <span class="cc-value" id="cc-hue-val">0.00</span>
            </div>
            <div class="hs-slider">
              <label>Saturation</label>
              <div class="sat-track-container">
                <div class="sat-gradient"></div>
                <input type="range" class="sat-slider" min="0" max="2" step="0.01" value="1" id="cc-saturation"
                  oninput="updateHueSat()" onchange="sendHueSat()" ontouchend="sendHueSat()">
              </div>
              <span class="cc-value" id="cc-saturation-val">1.00</span>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- Hidden inputs for sync -->
    <div style="display:none;">
      <script>multiSubValues["contrast_adjust"] = [0.5, 1.0];</script>
      <input type="hidden" id="contrast_adjust_0_range" class="param-control" data-paramkey="contrast_adjust" data-paramtype="sub-range" data-subindex="0" value="0.5" data-default="0.5">
      <input type="hidden" id="contrast_adjust_1_range" class="param-control" data-paramkey="contrast_adjust" data-paramtype="sub-range" data-subindex="1" value="1.0" data-default="1.0">
      <script>multiSubValues["color_adjust"] = [0, 1.0];</script>
      <input type="hidden" id="color_adjust_0_range" class="param-control" data-paramkey="color_adjust" data-paramtype="sub-range" data-subindex="0" value="0" data-default="0">
      <input type="hidden" id="color_adjust_1_range" class="param-control" data-paramkey="color_adjust" data-paramtype="sub-range" data-subindex="1" value="1.0" data-default="1.0">
      <script>multiSubValues["lift_adjust"] = [0, 0, 0, 0];</script>
      <input type="hidden" id="lift_adjust_0_range" class="param-control" data-paramkey="lift_adjust" data-paramtype="sub-range" data-subindex="0" value="0" data-default="0">
      <input type="hidden" id="lift_adjust_1_range" class="param-control" data-paramkey="lift_adjust" data-paramtype="sub-range" data-subindex="1" value="0" data-default="0">
      <input type="hidden" id="lift_adjust_2_range" class="param-control" data-paramkey="lift_adjust" data-paramtype="sub-range" data-subindex="2" value="0" data-default="0">
      <input type="hidden" id="lift_adjust_3_range" class="param-control" data-paramkey="lift_adjust" data-paramtype="sub-range" data-subindex="3" value="0" data-default="0">
      <script>multiSubValues["gamma_adjust"] = [0, 0, 0, 0];</script>
      <input type="hidden" id="gamma_adjust_0_range" class="param-control" data-paramkey="gamma_adjust" data-paramtype="sub-range" data-subindex="0" value="0" data-default="0">
      <input type="hidden" id="gamma_adjust_1_range" class="param-control" data-paramkey="gamma_adjust" data-paramtype="sub-range" data-subindex="1" value="0" data-default="0">
      <input type="hidden" id="gamma_adjust_2_range" class="param-control" data-paramkey="gamma_adjust" data-paramtype="sub-range" data-subindex="2" value="0" data-default="0">
      <input type="hidden" id="gamma_adjust_3_range" class="param-control" data-paramkey="gamma_adjust" data-paramtype="sub-range" data-subindex="3" value="0" data-default="0">
      <script>multiSubValues["gain_adjust"] = [1.0, 1.0, 1.0, 1.0];</script>
      <input type="hidden" id="gain_adjust_0_range" class="param-control" data-paramkey="gain_adjust" data-paramtype="sub-range" data-subindex="0" value="1.0" data-default="1.0">
      <input type="hidden" id="gain_adjust_1_range" class="param-control" data-paramkey="gain_adjust" data-paramtype="sub-range" data-subindex="1" value="1.0" data-default="1.0">
      <input type="hidden" id="gain_adjust_2_range" class="param-control" data-paramkey="gain_adjust" data-paramtype="sub-range" data-subindex="2" value="1.0" data-default="1.0">
      <input type="hidden" id="gain_adjust_3_range" class="param-control" data-paramkey="gain_adjust" data-paramtype="sub-range" data-subindex="3" value="1.0" data-default="1.0">
      <script>multiSubValues["offset_adjust"] = [0, 0, 0, 0];</script>
      <input type="hidden" id="offset_adjust_0_range" class="param-control" data-paramkey="offset_adjust" data-paramtype="sub-range" data-subindex="0" value="0" data-default="0">
      <input type="hidden" id="offset_adjust_1_range" class="param-control" data-paramkey="offset_adjust" data-paramtype="sub-range" data-subindex="1" value="0" data-default="0">
      <input type="hidden" id="offset_adjust_2_range" class="param-control" data-paramkey="offset_adjust" data-paramtype="sub-range" data-subindex="2" value="0" data-default="0">
      <input type="hidden" id="offset_adjust_3_range" class="param-control" data-paramkey="offset_adjust" data-paramtype="sub-range" data-subindex="3" value="0" data-default="0">
      <input type="hidden" id="luma_mix_range" class="param-control" data-paramkey="luma_mix" data-paramtype="range" value="1.0" data-default="1.0">
    </div>
    
  </div>

  <!-- ===== OUTPUT TAB ===== -->
  <div id="group_output" class="tabcontent">
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üìê Frame Guides & Overlays</span>
      </div>
      <div class="control-panel-body">
        <div class="settings-grid">
          
          <div class="setting-item">
            <label>Frame Guide Style</label>
            <div class="toggle-group" id="toggle-overlays_0">
              <button class="toggle-btn" data-value="0" onclick="setOverlayValue(0, 0, this)">Off</button>
              <button class="toggle-btn" data-value="5" onclick="setOverlayValue(0, 5, this)">16:9</button>
              <button class="toggle-btn" data-value="6" onclick="setOverlayValue(0, 6, this)">14:9</button>
              <button class="toggle-btn" data-value="7" onclick="setOverlayValue(0, 7, this)">4:3</button>
              <button class="toggle-btn" data-value="1" onclick="setOverlayValue(0, 1, this)">2.4:1</button>
              <button class="toggle-btn" data-value="2" onclick="setOverlayValue(0, 2, this)">2.39:1</button>
              <button class="toggle-btn" data-value="3" onclick="setOverlayValue(0, 3, this)">2.35:1</button>
              <button class="toggle-btn" data-value="8" onclick="setOverlayValue(0, 8, this)">2:1</button>
              <button class="toggle-btn" data-value="4" onclick="setOverlayValue(0, 4, this)">1.85:1</button>
              <button class="toggle-btn" data-value="9" onclick="setOverlayValue(0, 9, this)">4:5</button>
              <button class="toggle-btn" data-value="10" onclick="setOverlayValue(0, 10, this)">1:1</button>
            </div>
            <input type="hidden" id="overlays_0_range" class="param-control"
              data-paramkey="overlays" data-paramtype="sub-range" data-subindex="0" data-default="5" value="5">
          </div>
          
          <div class="setting-item">
            <div class="slider-header">
              <label>Guide Opacity</label>
              <button class="slider-reset" onclick="resetSubSlider('overlays', 1)">‚ü≥</button>
            </div>
            <div class="slider-header">
              <input type="range" class="styled-slider param-control" id="overlays_1_range"
                data-paramkey="overlays" data-paramtype="sub-range" data-subindex="1"
                min="0" max="100" step="10" value="100" data-default="100"
                oninput="styledSliderInput('overlays', 1, this)"
                onchange="multiSubOnChange('overlays')">
              <input type="number" class="slider-input" id="overlays_1_input" value="100" min="0" max="100" style="width:50px;margin-left:8px;">
            </div>
          </div>
          
          <div class="setting-item">
            <div class="slider-header">
              <label>Safe Area %</label>
              <button class="slider-reset" onclick="resetSubSlider('overlays', 2)">‚ü≥</button>
            </div>
            <div class="slider-header">
              <input type="range" class="styled-slider param-control" id="overlays_2_range"
                data-paramkey="overlays" data-paramtype="sub-range" data-subindex="2"
                min="0" max="100" step="5" value="90" data-default="90"
                oninput="styledSliderInput('overlays', 2, this)"
                onchange="multiSubOnChange('overlays')">
              <input type="number" class="slider-input" id="overlays_2_input" value="90" min="0" max="100" style="width:50px;margin-left:8px;">
            </div>
          </div>
          
          <div class="setting-item">
            <label>Grid Overlays</label>
            <div class="checkbox-group">
              <label class="checkbox-item"><input type="checkbox" id="grid_thirds" onchange="updateGridOverlays()" checked> Thirds</label>
              <label class="checkbox-item"><input type="checkbox" id="grid_crosshairs" onchange="updateGridOverlays()" checked> Crosshairs</label>
              <label class="checkbox-item"><input type="checkbox" id="grid_center" onchange="updateGridOverlays()"> Center</label>
              <label class="checkbox-item"><input type="checkbox" id="grid_horizon" onchange="updateGridOverlays()" checked> Horizon</label>
            </div>
            <input type="hidden" id="overlays_3_range" class="param-control"
              data-paramkey="overlays" data-paramtype="sub-range" data-subindex="3" data-default="11" value="11">
          </div>
          
        </div>
        <script>multiSubValues["overlays"] = [5, 100, 90, 11];</script>
      </div>
    </div>
    
  </div>

  <!-- ===== DISPLAY TAB ===== -->
  <div id="group_display" class="tabcontent">
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üñ•Ô∏è Display Settings</span>
      </div>
      <div class="control-panel-body">
        <div class="slider-row">
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Brightness</label>
              <button class="slider-reset" onclick="resetSlider('brightness')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="brightness_input"
                data-paramkey="brightness" data-paramtype="range" data-default="1"
                value="1.00" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="brightness_range"
              data-paramkey="brightness" data-paramtype="range"
              min="0" max="1" step="0.1" value="1" data-default="1"
              oninput="simpleSliderInput('brightness', this)" onchange="simpleSliderChange('brightness', this)">
          </div>
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Zebra Level</label>
              <button class="slider-reset" onclick="resetSlider('zebra_level')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="zebra_level_input"
                data-paramkey="zebra_level" data-paramtype="range" data-default="0.5"
                value="0.50" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="zebra_level_range"
              data-paramkey="zebra_level" data-paramtype="range"
              min="0" max="1" step="0.1" value="0.5" data-default="0.5"
              oninput="simpleSliderInput('zebra_level', this)" onchange="simpleSliderChange('zebra_level', this)">
          </div>
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Peaking Level</label>
              <button class="slider-reset" onclick="resetSlider('peaking_level')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="peaking_level_input"
                data-paramkey="peaking_level" data-paramtype="range" data-default="0.9"
                value="0.90" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="peaking_level_range"
              data-paramkey="peaking_level" data-paramtype="range"
              min="0" max="1" step="0.1" value="0.9" data-default="0.9"
              oninput="simpleSliderInput('peaking_level', this)" onchange="simpleSliderChange('peaking_level', this)">
          </div>
          
        </div>
      </div>
    </div>
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üîç Exposure & Focus Tools</span>
      </div>
      <div class="control-panel-body">
        <div class="settings-grid">
          
          <div class="setting-item">
            <label>Tools</label>
            <div class="checkbox-group">
              <label class="checkbox-item"><input type="checkbox" id="exposure_and_focus_tools_zebra"> Zebra</label>
              <label class="checkbox-item"><input type="checkbox" id="exposure_and_focus_tools_focus"> Focus Assist</label>
              <label class="checkbox-item"><input type="checkbox" id="exposure_and_focus_tools_false_color"> False Color</label>
            </div>
            <input type="hidden" id="exposure_and_focus_tools_0_range" class="param-control"
              data-paramkey="exposure_and_focus_tools" data-paramtype="sub-range" data-subindex="0" data-default="0" value="0">
          </div>
          
          <div class="setting-item">
            <label>Target Displays</label>
            <div class="checkbox-group">
              <label class="checkbox-item"><input type="checkbox" id="exposure_and_focus_tools_lcd"> LCD</label>
              <label class="checkbox-item"><input type="checkbox" id="exposure_and_focus_tools_hdmi"> HDMI</label>
              <label class="checkbox-item"><input type="checkbox" id="exposure_and_focus_tools_evf"> EVF</label>
              <label class="checkbox-item"><input type="checkbox" id="exposure_and_focus_tools_main_sdi"> Main SDI</label>
            </div>
            <input type="hidden" id="exposure_and_focus_tools_1_range" class="param-control"
              data-paramkey="exposure_and_focus_tools" data-paramtype="sub-range" data-subindex="1" data-default="0" value="0">
          </div>
          
          <div class="setting-item">
            <label>&nbsp;</label>
            <button class="panel-action-btn" onclick="applyExposureFocusTools()" style="width:100%;">‚ñ∂ Apply Tools</button>
          </div>
          
          <div class="setting-item">
            <label>Focus Assist Method</label>
            <div class="toggle-group" id="toggle-focus_assist_0">
              <button class="toggle-btn" data-value="0" onclick="setFocusAssist(0, 0, this)">Peak</button>
              <button class="toggle-btn active" data-value="1" onclick="setFocusAssist(0, 1, this)">Colored Lines</button>
            </div>
            <input type="hidden" id="focus_assist_0_range" class="param-control"
              data-paramkey="focus_assist" data-paramtype="sub-range" data-subindex="0" data-default="1" value="1">
          </div>
          
          <div class="setting-item">
            <label>Focus Line Color</label>
            <div class="toggle-group" id="toggle-focus_assist_1">
              <button class="toggle-btn active" data-value="0" onclick="setFocusAssist(1, 0, this)">Red</button>
              <button class="toggle-btn" data-value="1" onclick="setFocusAssist(1, 1, this)">Green</button>
              <button class="toggle-btn" data-value="2" onclick="setFocusAssist(1, 2, this)">Blue</button>
              <button class="toggle-btn" data-value="3" onclick="setFocusAssist(1, 3, this)">White</button>
            </div>
            <input type="hidden" id="focus_assist_1_range" class="param-control"
              data-paramkey="focus_assist" data-paramtype="sub-range" data-subindex="1" data-default="0" value="0">
          </div>
          
          <div class="setting-item">
            <div class="slider-header">
              <label>Color Bars (seconds)</label>
              <button class="slider-reset" onclick="resetSlider('color_bars_display_time_seconds')">‚ü≥</button>
            </div>
            <div class="slider-header">
              <input type="range" class="styled-slider param-control" id="color_bars_display_time_seconds_range"
                data-paramkey="color_bars_display_time_seconds" data-paramtype="range"
                min="0" max="30" step="1" value="0" data-default="0"
                oninput="simpleSliderInput('color_bars_display_time_seconds', this)" onchange="simpleSliderChange('color_bars_display_time_seconds', this)">
              <input type="number" class="slider-input" id="color_bars_display_time_seconds_input" value="0" min="0" max="30" style="width:50px;margin-left:8px;">
            </div>
          </div>
          
          <div class="setting-item">
            <label>Timecode Source</label>
            <div class="toggle-group" id="toggle-timecode_source">
              <button class="toggle-btn active" data-value="0" onclick="setToggleValue('timecode_source', 0, this)">Clip</button>
              <button class="toggle-btn" data-value="1" onclick="setToggleValue('timecode_source', 1, this)">Timecode</button>
            </div>
            <input type="hidden" id="timecode_source_range" class="param-control"
              data-paramkey="timecode_source" data-paramtype="range" data-default="0" value="0">
          </div>
          
        </div>
        <script>multiSubValues["exposure_and_focus_tools"] = [0, 0]; multiSubValues["focus_assist"] = [1, 0];</script>
      </div>
    </div>
    
  </div>

  <!-- ===== AUDIO TAB ===== -->
  <div id="group_audio" class="tabcontent">
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üé§ Input Levels</span>
      </div>
      <div class="control-panel-body">
        <div class="slider-row">
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Mic Level</label>
              <button class="slider-reset" onclick="resetSlider('mic_level')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="mic_level_input"
                data-paramkey="mic_level" data-paramtype="range" data-default="0.7"
                value="0.70" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="mic_level_range"
              data-paramkey="mic_level" data-paramtype="range"
              min="0" max="1" step="0.1" value="0.7" data-default="0.7"
              oninput="simpleSliderInput('mic_level', this)" onchange="simpleSliderChange('mic_level', this)">
          </div>
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Channel 1</label>
              <button class="slider-reset" onclick="resetSubSlider('input_levels', 0)">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="input_levels_0_input"
                data-paramkey="input_levels" data-paramtype="sub-range" data-subindex="0" data-default="0.5"
                value="0.50" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="input_levels_0_range"
              data-paramkey="input_levels" data-paramtype="sub-range" data-subindex="0"
              min="0" max="1" step="0.1" value="0.5" data-default="0.5"
              oninput="styledSliderInput('input_levels', 0, this)"
              onchange="multiSubOnChange('input_levels')">
          </div>
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Channel 2</label>
              <button class="slider-reset" onclick="resetSubSlider('input_levels', 1)">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="input_levels_1_input"
                data-paramkey="input_levels" data-paramtype="sub-range" data-subindex="1" data-default="0.5"
                value="0.50" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="input_levels_1_range"
              data-paramkey="input_levels" data-paramtype="sub-range" data-subindex="1"
              min="0" max="1" step="0.1" value="0.5" data-default="0.5"
              oninput="styledSliderInput('input_levels', 1, this)"
              onchange="multiSubOnChange('input_levels')">
          </div>
          
        </div>
        <script>multiSubValues["input_levels"] = [0.5, 0.5];</script>
      </div>
    </div>
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üéß Output & Monitoring</span>
      </div>
      <div class="control-panel-body">
        <div class="slider-row">
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Headphone Level</label>
              <button class="slider-reset" onclick="resetSlider('headphone_level')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="headphone_level_input"
                data-paramkey="headphone_level" data-paramtype="range" data-default="1"
                value="1.00" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="headphone_level_range"
              data-paramkey="headphone_level" data-paramtype="range"
              min="0" max="1" step="0.1" value="1" data-default="1"
              oninput="simpleSliderInput('headphone_level', this)" onchange="simpleSliderChange('headphone_level', this)">
          </div>
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Program Mix</label>
              <button class="slider-reset" onclick="resetSlider('headphone_program_mix')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="headphone_program_mix_input"
                data-paramkey="headphone_program_mix" data-paramtype="range" data-default="0"
                value="0.00" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="headphone_program_mix_range"
              data-paramkey="headphone_program_mix" data-paramtype="range"
              min="0" max="1" step="0.1" value="0" data-default="0"
              oninput="simpleSliderInput('headphone_program_mix', this)" onchange="simpleSliderChange('headphone_program_mix', this)">
          </div>
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Speaker Level</label>
              <button class="slider-reset" onclick="resetSlider('speaker_level')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="speaker_level_input"
                data-paramkey="speaker_level" data-paramtype="range" data-default="1"
                value="1.00" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="speaker_level_range"
              data-paramkey="speaker_level" data-paramtype="range"
              min="0" max="1" step="0.1" value="1" data-default="1"
              oninput="simpleSliderInput('speaker_level', this)" onchange="simpleSliderChange('speaker_level', this)">
          </div>
          
        </div>
      </div>
    </div>
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">‚öôÔ∏è Audio Settings</span>
      </div>
      <div class="control-panel-body">
        <div class="settings-grid">
          
          <div class="setting-item">
            <label>Input Type</label>
            <div class="toggle-group" id="toggle-input_type">
              <button class="toggle-btn active" data-value="0" onclick="setToggleValue('input_type', 0, this)">Internal</button>
              <button class="toggle-btn" data-value="1" onclick="setToggleValue('input_type', 1, this)">Line</button>
              <button class="toggle-btn" data-value="2" onclick="setToggleValue('input_type', 2, this)">Mic Low</button>
              <button class="toggle-btn" data-value="3" onclick="setToggleValue('input_type', 3, this)">Mic High</button>
            </div>
            <input type="hidden" id="input_type_range" class="param-control"
              data-paramkey="input_type" data-paramtype="range" data-default="0" value="0">
          </div>
          
          <div class="setting-item">
            <label>Phantom Power (+48V)</label>
            <label class="switch">
              <input type="checkbox" class="param-control" id="phantom_power_check"
                data-paramkey="phantom_power" data-paramtype="checkbox" data-default="0"
                onchange="toggleCheckbox('phantom_power', this)">
              <span class="switch-slider"></span>
            </label>
          </div>
          
        </div>
      </div>
    </div>
    
  </div>

  <!-- ===== TALLY TAB ===== -->
  <div id="group_tally" class="tabcontent">
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üî¥ Tally Light Brightness</span>
      </div>
      <div class="control-panel-body">
        <div class="slider-row">
          
          <div class="slider-control">
            <div class="slider-header">
              <label>All Tally</label>
              <button class="slider-reset" onclick="resetSlider('tally_brightness')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="tally_brightness_input"
                data-paramkey="tally_brightness" data-paramtype="range" data-default="1"
                value="1.00" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="tally_brightness_range"
              data-paramkey="tally_brightness" data-paramtype="range"
              min="0" max="1" step="0.1" value="1" data-default="1"
              oninput="simpleSliderInput('tally_brightness', this)" onchange="simpleSliderChange('tally_brightness', this)">
          </div>
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Front Tally</label>
              <button class="slider-reset" onclick="resetSlider('front_tally_brightness')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="front_tally_brightness_input"
                data-paramkey="front_tally_brightness" data-paramtype="range" data-default="1"
                value="1.00" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="front_tally_brightness_range"
              data-paramkey="front_tally_brightness" data-paramtype="range"
              min="0" max="1" step="0.1" value="1" data-default="1"
              oninput="simpleSliderInput('front_tally_brightness', this)" onchange="simpleSliderChange('front_tally_brightness', this)">
          </div>
          
          <div class="slider-control">
            <div class="slider-header">
              <label>Rear Tally</label>
              <button class="slider-reset" onclick="resetSlider('rear_tally_brightness')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="rear_tally_brightness_input"
                data-paramkey="rear_tally_brightness" data-paramtype="range" data-default="1"
                value="1.00" min="0" max="1" step="0.1">
            </div>
            <input type="range" class="styled-slider param-control" id="rear_tally_brightness_range"
              data-paramkey="rear_tally_brightness" data-paramtype="range"
              min="0" max="1" step="0.1" value="1" data-default="1"
              oninput="simpleSliderInput('rear_tally_brightness', this)" onchange="simpleSliderChange('rear_tally_brightness', this)">
          </div>
          
        </div>
      </div>
    </div>
    
  </div>

  <!-- ===== REFERENCE TAB ===== -->
  <div id="group_reference" class="tabcontent">
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">‚è±Ô∏è Reference Source</span>
      </div>
      <div class="control-panel-body">
        <div class="settings-grid">
          
          <div class="setting-item">
            <label>Source</label>
            <div class="toggle-group" id="toggle-source">
              <button class="toggle-btn active" data-value="0" onclick="setToggleValue('source', 0, this)">Internal</button>
              <button class="toggle-btn" data-value="1" onclick="setToggleValue('source', 1, this)">Program</button>
              <button class="toggle-btn" data-value="2" onclick="setToggleValue('source', 2, this)">External</button>
            </div>
            <input type="hidden" id="source_range" class="param-control"
              data-paramkey="source" data-paramtype="range" data-default="0" value="0">
          </div>
          
          <div class="slider-control" style="max-width:250px;">
            <div class="slider-header">
              <label>Offset (pixels)</label>
              <button class="slider-reset" onclick="resetSlider('offset')">‚ü≥</button>
              <input type="number" class="slider-input param-control" id="offset_input"
                data-paramkey="offset" data-paramtype="range" data-default="0"
                value="0" min="0" max="100" step="1">
            </div>
            <input type="range" class="styled-slider param-control" id="offset_range"
              data-paramkey="offset" data-paramtype="range"
              min="0" max="100" step="1" value="0" data-default="0"
              oninput="simpleSliderInput('offset', this)" onchange="simpleSliderChange('offset', this)">
          </div>
          
        </div>
      </div>
    </div>
    
  </div>

  <!-- ===== PTZ TAB ===== -->
  <div id="group_ptz_control" class="tabcontent">
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üïπÔ∏è Pan/Tilt Control</span>
      </div>
      <div class="control-panel-body">
        <div class="ptz-layout">
          
          <div class="ptz-joystick-section">
            <div class="joystick-container">
              <div class="joystick" id="ptz-joystick">
                <div class="joystick-handle" id="joystick-handle"></div>
              </div>
              <div class="joystick-labels">
                <span>Pan: <span id="pan-value">0.00</span></span>
                <span>Tilt: <span id="tilt-value">0.00</span></span>
              </div>
            </div>
          </div>
          
          <div class="ptz-presets-section">
            <label class="section-label">Memory Presets</label>
            <div class="memory-grid">
              <button class="memory-btn active" id="memory_slot_select_btn_0" onclick="setMemoryPresetSelection(0)">Slot 1</button>
              <button class="memory-btn" id="memory_slot_select_btn_1" onclick="setMemoryPresetSelection(1)">Slot 2</button>
              <button class="memory-btn" id="memory_slot_select_btn_2" onclick="setMemoryPresetSelection(2)">Slot 3</button>
              <button class="memory-btn" id="memory_slot_select_btn_3" onclick="setMemoryPresetSelection(3)">Slot 4</button>
              <button class="memory-btn" id="memory_slot_select_btn_4" onclick="setMemoryPresetSelection(4)">Slot 5</button>
              <button class="memory-btn" id="memory_slot_select_btn_5" onclick="setMemoryPresetSelection(5)">Slot 6</button>
            </div>
            <div class="memory-actions">
              <button class="memory-action-btn recall" onclick="setMemoryPresetAction(2)">Recall</button>
              <button class="memory-action-btn save" onclick="setMemoryPresetAction(1)">Save</button>
              <button class="memory-action-btn reset" onclick="setMemoryPresetAction(0)">Reset</button>
            </div>
          </div>
          
          <div style="display:none;">
            <script>multiSubValues["pan_tilt_velocity"] = [0, 0]; multiSubValues["memory_preset"] = [0, 0];</script>
            <input type="hidden" id="pan_tilt_velocity_0_range" class="param-control"
              data-paramkey="pan_tilt_velocity" data-paramtype="sub-range" data-subindex="0" value="0" data-default="0">
            <input type="hidden" id="pan_tilt_velocity_1_range" class="param-control"
              data-paramkey="pan_tilt_velocity" data-paramtype="sub-range" data-subindex="1" value="0" data-default="0">
          </div>
          
        </div>
      </div>
    </div>
    
  </div>

</div>
  </main>
</div>

<script>
// =============================================
// JAVASCRIPT - CORE FUNCTIONALITY
// =============================================

// === ESTADO GLOBAL ===
let currentCamera = 1;
const MAX_CAMERAS = 8;
const MAX_PRESETS = 5;

const cameraValues = {};
for (let i = 1; i <= MAX_CAMERAS; i++) cameraValues[i] = {};

// multiSubValues ya definido al inicio del body
let selectedParamGroups = {};

// === FUNCIONES DE CACH√â ===
function cacheValue(paramKey, value, subIndex = null) {
    const key = subIndex !== null ? `${paramKey}[${subIndex}]` : paramKey;
    cameraValues[currentCamera][key] = value;
}

function restoreUIFromCache() {
    const cache = cameraValues[currentCamera];
    document.querySelectorAll('.param-control').forEach(el => {
        const paramKey = el.dataset.paramkey;
        const subIndex = el.dataset.subindex;
        const key = subIndex !== undefined ? `${paramKey}[${subIndex}]` : paramKey;
        if (cache[key] !== undefined) updateControlValue(el, cache[key]);
    });
}

function updateControlValue(el, value) {
    const type = el.dataset.paramtype;
    const paramKey = el.dataset.paramkey;
    
    if (type === 'checkbox' || type === 'sub-check') {
        el.checked = (value == 1 || value === true);
    } else if (el.tagName === 'SELECT') {
        el.value = value;
    } else if (type === 'range' || type === 'sub-range') {
        el.value = value;
        const inputId = el.id.replace('_range', '_input');
        const input = document.getElementById(inputId);
        if (input) input.value = parseFloat(value).toFixed(2);
    } else {
        el.value = value;
    }
    
    // If it's a knob input, also update the indicator
    if (paramKey && el.classList.contains('knob-input')) {
        const knobName = Object.keys(knobConfig).find(k => knobConfig[k].param === paramKey);
        if (knobName) {
            knobConfig[knobName].value = parseFloat(value);
            updateKnobIndicator(knobName, parseFloat(value));
        }
    }
    
    // Si es un hidden input de toggle, actualizar el toggle visual
    if (paramKey && el.type === 'hidden') {
        updateToggleVisual(paramKey, value);
    }
}

// === UI ===
function showTab(tabId) {
    document.querySelectorAll('.tabcontent').forEach(t => t.style.display = 'none');
    const tab = document.getElementById(tabId);
    if (tab) tab.style.display = 'block';
    document.querySelectorAll('.sidebar-tab').forEach(b => b.classList.remove('active-tab'));
    const btn = document.querySelector(`.sidebar-tab[onclick="showTab('${tabId}')"]`);
    if (btn) btn.classList.add('active-tab');
}

function highlightCameraButton(camNum) {
    document.querySelectorAll('.camera-btn').forEach(b => b.classList.remove('active-camera'));
    const btn = document.getElementById('camBtn' + camNum);
    if (btn) btn.classList.add('active-camera');
}

function setCameraId(num) {
    saveCurrentStateToCache();
    currentCamera = num;
    highlightCameraButton(num);
    fetch(`/?cameraId=${num}`);
    restoreUIFromCache();
    updatePresetNames();
}

function saveCurrentStateToCache() {
    document.querySelectorAll('.param-control').forEach(el => {
        const paramKey = el.dataset.paramkey;
        const subIndex = el.dataset.subindex;
        const type = el.dataset.paramtype;
        let value = (type === 'checkbox' || type === 'sub-check') ? (el.checked ? 1 : 0) : el.value;
        cacheValue(paramKey, value, subIndex !== undefined ? parseInt(subIndex) : null);
    });
}

// === ENV√çO DE PAR√ÅMETROS ===
function sendParam(key, val) {
    const v = typeof val === 'number' ? parseFloat(val.toFixed(2)) : val;
    cacheValue(key, v);
    fetch(`/?cameraId=${currentCamera}&${key}=${encodeURIComponent(v)}`);
}

function triggerVoid(key) {
    fetch(`/?cameraId=${currentCamera}&${key}=1`);
}

function toggleCheckbox(key, cb) {
    const v = cb.checked ? 1 : 0;
    cacheValue(key, v);
    sendParam(key, v);
}

// === SLIDERS SIMPLES ===
function simpleSliderInput(paramKey, slider) {
    const value = parseFloat(slider.value);
    const input = document.getElementById(paramKey + '_input');
    if (input) input.value = value.toFixed(2);
    cacheValue(paramKey, value);
    // Only update UI, don't send
}

function simpleSliderChange(paramKey, slider) {
    const value = parseFloat(slider.value);
    sendParam(paramKey, value);
}

function resetSlider(paramKey) {
    const range = document.getElementById(paramKey + '_range');
    const input = document.getElementById(paramKey + '_input');
    if (range) {
        const defaultVal = parseFloat(range.dataset.default) || 0;
        range.value = defaultVal;
        if (input) input.value = defaultVal.toFixed(2);
        cacheValue(paramKey, defaultVal);
        sendParam(paramKey, defaultVal);
    }
}

function resetSubSlider(paramKey, subIndex) {
    const range = document.getElementById(`${paramKey}_${subIndex}_range`);
    const input = document.getElementById(`${paramKey}_${subIndex}_input`);
    if (range) {
        const defaultVal = parseFloat(range.dataset.default) || 0;
        range.value = defaultVal;
        if (input) input.value = defaultVal.toFixed(2);
        if (!multiSubValues[paramKey]) multiSubValues[paramKey] = [];
        multiSubValues[paramKey][subIndex] = defaultVal;
        cacheValue(paramKey, defaultVal, subIndex);
        multiSubOnChange(paramKey);
    }
}

// === STYLED SLIDERS ===
function styledSliderInput(paramKey, subIndex, slider) {
    const value = parseFloat(slider.value);
    const input = document.getElementById(`${paramKey}_${subIndex}_input`);
    if (input) input.value = paramKey === 'manual_white_balance' && subIndex === 0 ? Math.round(value) : value.toFixed(2);
    if (!multiSubValues[paramKey]) multiSubValues[paramKey] = [];
    multiSubValues[paramKey][subIndex] = value;
    cacheValue(paramKey, value, subIndex);
}

function multiSubOnChange(key) {
    if (key === "pan_tilt_velocity") {
        multiSubValues[key] = [0, 0];
        fetch(`/?cameraId=${currentCamera}&${key}=0,0`);
    } else {
        const arr = multiSubValues[key] || [];
        const valStr = arr.map(v => typeof v === 'number' ? parseFloat(v.toFixed(2)) : v).join(",");
        fetch(`/?cameraId=${currentCamera}&${key}=${encodeURIComponent(valStr)}`);
    }
}

// === TOGGLE GROUPS ===
function setToggleValue(paramKey, value, clickedBtn) {
    const group = clickedBtn.closest('.toggle-group');
    group.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
    clickedBtn.classList.add('active');
    const hiddenInput = document.getElementById(`${paramKey}_range`);
    if (hiddenInput) hiddenInput.value = value;
    cacheValue(paramKey, value);
    sendParam(paramKey, value);
}

function updateToggleVisual(paramKey, value) {
    const group = document.getElementById(`toggle-${paramKey}`);
    if (!group) return;
    group.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.value == value) btn.classList.add('active');
    });
}

// === CONTINUOUS SLIDERS ===
function continuousSliderInput(paramKey, slider) {
    const value = parseFloat(slider.value);
    const input = document.getElementById(paramKey + '_input');
    if (input) input.value = value.toFixed(2);
    cacheValue(paramKey, value);
    sendParam(paramKey, value);
}

function continuousSliderRelease(paramKey, slider) {
    slider.value = 0;
    const input = document.getElementById(paramKey + '_input');
    if (input) input.value = "0.00";
    cacheValue(paramKey, 0);
    sendParam(paramKey, 0);
}

// === OVERRIDES ===
function updateToggleBtn(btnId, isOn) {
    const btn = document.getElementById(btnId);
    if (btn) {
        btn.classList.toggle('active', isOn);
        btn.querySelector('.status').textContent = isOn ? 'On' : 'Off';
    }
}

function getOverrides() {
    fetch('/?getOverrides=1')
        .then(r => r.json())
        .then(data => {
            if (data.overrideTally !== undefined) updateToggleBtn('btnTally', data.overrideTally);
            if (data.overrideCCU !== undefined) updateToggleBtn('btnCCU', data.overrideCCU);
        })
        .catch(() => {
            updateToggleBtn('btnTally', true);
            updateToggleBtn('btnCCU', true);
        });
}

function toggleOverrideTally() {
    const btn = document.getElementById('btnTally');
    const newVal = btn.classList.contains('active') ? 0 : 1;
    fetch(`/?overrideTally=${newVal}`).then(() => updateToggleBtn('btnTally', newVal));
}

function toggleOverrideCCU() {
    const btn = document.getElementById('btnCCU');
    const newVal = btn.classList.contains('active') ? 0 : 1;
    fetch(`/?overrideCCU=${newVal}`).then(() => updateToggleBtn('btnCCU', newVal));
}

let vmixConnectEnabled = true;

function getVmixConnectStatus() {
    fetch('/?getVmixConnect=1')
        .then(r => r.text())
        .then(text => {
            const match = text.match(/\{.*\}/);
            if (match) {
                const data = JSON.parse(match[0]);
                if (data.vmixConnectEnabled !== undefined) {
                    vmixConnectEnabled = data.vmixConnectEnabled;
                    updateToggleBtn('btnVmix', vmixConnectEnabled);
                }
            }
        })
        .catch(console.error);
}

function toggleVmixConnect() {
    vmixConnectEnabled = !vmixConnectEnabled;
    fetch(`/?vmixConnect=${vmixConnectEnabled ? 1 : 0}`)
        .then(() => updateToggleBtn('btnVmix', vmixConnectEnabled));
}

function rebootArduino() {
    if (confirm("Reboot the Arduino?")) fetch('/reboot');
}

// === GROUPS ===
function toggleParamGroup(groupId) {
    const cb = document.getElementById(`group_selector_${groupId}`);
    selectedParamGroups[groupId] = cb.checked;
    localStorage.setItem('selectedParamGroups', JSON.stringify(selectedParamGroups));
}

function toggleAllParamGroups(state) {
    Object.keys(selectedParamGroups).forEach(group => {
        selectedParamGroups[group] = state;
        const cb = document.getElementById(`group_selector_${group}`);
        if (cb) cb.checked = state;
    });
    localStorage.setItem('selectedParamGroups', JSON.stringify(selectedParamGroups));
}

function setDefaultParamGroups() {
    const defaults = ["lens", "video", "color_correction"];
    Object.keys(selectedParamGroups).forEach(group => {
        const isDefault = defaults.includes(group);
        selectedParamGroups[group] = isDefault;
        const cb = document.getElementById(`group_selector_${group}`);
        if (cb) cb.checked = isDefault;
    });
    localStorage.setItem('selectedParamGroups', JSON.stringify(selectedParamGroups));
}

// === EXPOSURE/FOCUS TOOLS ===
function getExposureFocusToolsValues() {
    const key = 'exposure_and_focus_tools';
    let tools = 0;
    if (document.getElementById(key + '_zebra')?.checked) tools += 1;
    if (document.getElementById(key + '_focus')?.checked) tools += 2;
    if (document.getElementById(key + '_false_color')?.checked) tools += 4;
    
    let displays = 0;
    if (document.getElementById(key + '_lcd')?.checked) displays += 1;
    if (document.getElementById(key + '_hdmi')?.checked) displays += 2;
    if (document.getElementById(key + '_evf')?.checked) displays += 4;
    if (document.getElementById(key + '_main_sdi')?.checked) displays += 8;
    
    return { tools, displays };
}

function updateExposureFocusTools() {
    const key = 'exposure_and_focus_tools';
    const { tools, displays } = getExposureFocusToolsValues();
    
    multiSubValues[key] = [tools, displays];
    const hiddenInput0 = document.getElementById(key + '_0_range');
    const hiddenInput1 = document.getElementById(key + '_1_range');
    if (hiddenInput0) hiddenInput0.value = tools;
    if (hiddenInput1) hiddenInput1.value = displays;
}

function applyExposureFocusTools() {
    const key = 'exposure_and_focus_tools';
    const { tools, displays } = getExposureFocusToolsValues();
    
    multiSubValues[key] = [tools, displays];
    const hiddenInput0 = document.getElementById(key + '_0_range');
    const hiddenInput1 = document.getElementById(key + '_1_range');
    if (hiddenInput0) hiddenInput0.value = tools;
    if (hiddenInput1) hiddenInput1.value = displays;
    
    fetch(`/?cameraId=${currentCamera}&${key}=${tools},${displays}`);
}

function setFocusAssist(subIndex, value, btn) {
    const group = btn.closest('.toggle-group');
    group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (!multiSubValues["focus_assist"]) multiSubValues["focus_assist"] = [1, 0];
    multiSubValues["focus_assist"][subIndex] = value;
    // Actualizar hidden input
    const hiddenInput = document.getElementById(`focus_assist_${subIndex}_range`);
    if (hiddenInput) hiddenInput.value = value;
    fetch(`/?cameraId=${currentCamera}&focus_assist=${multiSubValues["focus_assist"].join(',')}`);
}

function updateOverlayToggleVisual(subIndex, value) {
    const group = document.getElementById(`toggle-overlays_${subIndex}`);
    if (!group) return;
    group.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.value == value) btn.classList.add('active');
    });
}

function updateFocusAssistToggleVisual(subIndex, value) {
    const group = document.getElementById(`toggle-focus_assist_${subIndex}`);
    if (!group) return;
    group.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.value == value) btn.classList.add('active');
    });
}

function updateVideoModeToggleVisual(subIndex, value) {
    const group = document.getElementById(`toggle-video_mode_${subIndex}`);
    if (!group) return;
    group.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.value == value) btn.classList.add('active');
    });
}

function updateGridCheckboxesFromValue(value) {
    document.getElementById('grid_thirds').checked = (value & 1) !== 0;
    document.getElementById('grid_crosshairs').checked = (value & 2) !== 0;
    document.getElementById('grid_center').checked = (value & 4) !== 0;
    document.getElementById('grid_horizon').checked = (value & 8) !== 0;
}

function updateExposureToolsCheckboxesFromValue(tools, displays) {
    document.getElementById('exposure_and_focus_tools_zebra').checked = (tools & 1) !== 0;
    document.getElementById('exposure_and_focus_tools_focus').checked = (tools & 2) !== 0;
    document.getElementById('exposure_and_focus_tools_false_color').checked = (tools & 4) !== 0;
    document.getElementById('exposure_and_focus_tools_lcd').checked = (displays & 1) !== 0;
    document.getElementById('exposure_and_focus_tools_hdmi').checked = (displays & 2) !== 0;
    document.getElementById('exposure_and_focus_tools_evf').checked = (displays & 4) !== 0;
    document.getElementById('exposure_and_focus_tools_main_sdi').checked = (displays & 8) !== 0;
}

// === OVERLAYS ===
function setOverlayValue(subIndex, value, btn) {
    const group = btn.closest('.toggle-group');
    group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (!multiSubValues["overlays"]) multiSubValues["overlays"] = [5, 100, 90, 11];
    multiSubValues["overlays"][subIndex] = value;
    // Actualizar hidden input
    const hiddenInput = document.getElementById(`overlays_${subIndex}_range`);
    if (hiddenInput) hiddenInput.value = value;
    multiSubOnChange('overlays');
}

function updateGridOverlays() {
    let value = 0;
    if (document.getElementById('grid_thirds')?.checked) value += 1;
    if (document.getElementById('grid_crosshairs')?.checked) value += 2;
    if (document.getElementById('grid_center')?.checked) value += 4;
    if (document.getElementById('grid_horizon')?.checked) value += 8;
    if (!multiSubValues["overlays"]) multiSubValues["overlays"] = [5, 100, 90, 11];
    multiSubValues["overlays"][3] = value;
    // Actualizar hidden input
    const hiddenInput = document.getElementById('overlays_3_range');
    if (hiddenInput) hiddenInput.value = value;
    multiSubOnChange('overlays');
}

// === MEMORY PRESETS ===
function setMemoryPresetSelection(preset) {
    multiSubValues["memory_preset"][1] = preset;
    for (let i = 0; i < 6; i++) {
        const btn = document.getElementById("memory_slot_select_btn_" + i);
        if (btn) btn.classList.toggle("active", i === preset);
    }
}

function setMemoryPresetAction(action) {
    multiSubValues["memory_preset"][0] = action;
    const presetValue = multiSubValues["memory_preset"][1] || 0;
    fetch(`/?cameraId=${currentCamera}&memory_preset=${action},${presetValue}`);
}

// === KNOB CONTROLS ===
const knobConfig = {
    aperture: { min: 0, max: 1, value: 0, param: 'aperture_normalised', step: 0.05 },
    focus: { min: 0, max: 1, value: 0, param: 'focus', step: 0.05 },
    zoom: { min: 0, max: 1, value: 0, param: 'set_absolute_zoom_normalised', step: 0.05 },
    shutter: { min: 24, max: 2000, value: 50, param: 'shutter_speed', step: 1 },
    gain: { min: -12, max: 32, value: 0, param: 'gain_db', step: 2 },
    nd: { min: 0, max: 6, value: 0, param: 'nd_filter_stop', step: 2, subIndex: 0 }
};

function initKnob(name) {
    const knob = document.getElementById(`knob-${name}`);
    if (!knob) return;
    const config = knobConfig[name];
    let isDragging = false;
    let startY, startValue;
    
    updateKnobIndicator(name, config.value);
    
    knob.addEventListener('mousedown', (e) => {
        isDragging = true;
        startY = e.clientY;
        startValue = config.value;
        document.body.style.cursor = 'ns-resize';
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaY = startY - e.clientY;
        const range = config.max - config.min;
        const sensitivity = range / 150;
        let newValue = startValue + (deltaY * sensitivity);
        newValue = Math.max(config.min, Math.min(config.max, newValue));
        newValue = Math.round(newValue / config.step) * config.step;
        config.value = newValue;
        updateKnobDisplay(name, newValue);
        updateKnobIndicator(name, newValue);
    });
    
    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            document.body.style.cursor = '';
            sendKnobValue(name);
        }
    });
    
    knob.addEventListener('dblclick', () => {
        const defaults = { aperture: 0, focus: 0, zoom: 0, shutter: 50, gain: 0, nd: 0 };
        setKnobValue(name, defaults[name]);
    });
}

function updateKnobIndicator(name, value) {
    const knob = document.getElementById(`knob-${name}`);
    if (!knob) return;
    const config = knobConfig[name];
    const indicator = knob.querySelector('.knob-indicator');
    if (!indicator) return;
    const normalized = (value - config.min) / (config.max - config.min);
    const angle = -135 + (normalized * 270);
    indicator.style.transform = `translateX(-50%) rotate(${angle}deg)`;
}

function updateKnobDisplay(name, value) {
    const config = knobConfig[name];
    const inputId = config.subIndex !== undefined ? 
        `${config.param}_${config.subIndex}_input` : `${config.param}_input`;
    const input = document.getElementById(inputId);
    if (input) input.value = config.step < 1 ? value.toFixed(2) : Math.round(value);
}

function setKnobValue(name, value) {
    const config = knobConfig[name];
    config.value = value;
    updateKnobDisplay(name, value);
    updateKnobIndicator(name, value);
    sendKnobValue(name);
}

function adjustKnob(name, direction) {
    const config = knobConfig[name];
    let newValue;
    
    if (name === 'shutter') {
        // Shutter uses multiples of frame rate
        const fps = getCurrentFrameRate();
        const currentMultiple = Math.round(config.value / fps);
        const newMultiple = Math.max(1, currentMultiple + direction);
        newValue = fps * newMultiple;
    } else {
        const step = config.step || 1;
        newValue = config.value + (direction * step);
    }
    
    newValue = Math.max(config.min, Math.min(config.max, newValue));
    setKnobValue(name, newValue);
}

function sendKnobValue(name) {
    const config = knobConfig[name];
    if (config.subIndex !== undefined) {
        if (!multiSubValues[config.param]) multiSubValues[config.param] = [];
        multiSubValues[config.param][config.subIndex] = config.value;
        multiSubOnChange(config.param);
    } else {
        sendParam(config.param, config.value);
    }
}

// === COLOR WHEELS ===
const wheels = ['lift', 'gamma', 'gain', 'offset'];
const wheelDefaults = {
    lift: { r: 0, g: 0, b: 0, y: 0 },
    gamma: { r: 0, g: 0, b: 0, y: 0 },
    gain: { r: 1, g: 1, b: 1, y: 1 },
    offset: { r: 0, g: 0, b: 0, y: 0 }
};
const wheelData = JSON.parse(JSON.stringify(wheelDefaults));
const wheelParamMap = { lift: 'lift_adjust', gamma: 'gamma_adjust', gain: 'gain_adjust', offset: 'offset_adjust' };

function initColorWheels() {
    wheels.forEach(wheelName => {
        const wheel = document.getElementById(`wheel-${wheelName}`);
        const pointer = document.getElementById(`pointer-${wheelName}`);
        if (!wheel || !pointer) return;
        
        let isDragging = false;
        
        const updatePointer = (e) => {
            const rect = wheel.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const radius = rect.width / 2 - 8;
            
            // Mouse position relative to center
            let px = e.clientX - rect.left - centerX;
            let py = e.clientY - rect.top - centerY;
            
            // Limit to wheel radius
            const dist = Math.sqrt(px * px + py * py);
            if (dist > radius) {
                px = (px / dist) * radius;
                py = (py / dist) * radius;
            }
            
            // Normalize coordinates to -1 to 1
            const nx = px / radius;
            const ny = py / radius;
            
            // Position pointer using percentage (same as updateWheelDotFromRGB)
            pointer.style.left = ((nx + 1) / 2 * 100) + '%';
            pointer.style.top = ((ny + 1) / 2 * 100) + '%';
            
            // Calculate RGB
            const rgb = calculateWheelRGB(nx, ny, wheelName);
            
            document.getElementById(`${wheelName}-r`).value = rgb.r.toFixed(2);
            document.getElementById(`${wheelName}-g`).value = rgb.g.toFixed(2);
            document.getElementById(`${wheelName}-b`).value = rgb.b.toFixed(2);
            
            wheelData[wheelName].r = rgb.r;
            wheelData[wheelName].g = rgb.g;
            wheelData[wheelName].b = rgb.b;
        };
        
        wheel.addEventListener('mousedown', (e) => { isDragging = true; updatePointer(e); });
        document.addEventListener('mousemove', (e) => { if (isDragging) updatePointer(e); });
        document.addEventListener('mouseup', () => { if (isDragging) { isDragging = false; sendWheelValues(wheelName); } });
    });
}

function updateWheelMaster(wheelName, value) {
    const v = parseFloat(value);
    wheelData[wheelName].y = v;
    document.getElementById(`${wheelName}-y`).value = v.toFixed(2);
    // Only update UI, don't send
}

function sendWheelMaster(wheelName) {
    sendWheelValues(wheelName);
}

function sendWheelValues(wheelName) {
    const paramKey = wheelParamMap[wheelName];
    const data = wheelData[wheelName];
    // Limit to 2 decimals to reduce size
    const r = data.r.toFixed(2);
    const g = data.g.toFixed(2);
    const b = data.b.toFixed(2);
    const y = data.y.toFixed(2);
    multiSubValues[paramKey] = [parseFloat(r), parseFloat(g), parseFloat(b), parseFloat(y)];
    const valStr = `${r},${g},${b},${y}`;
    fetch(`/?cameraId=${currentCamera}&${paramKey}=${encodeURIComponent(valStr)}`);
}

// Ranges per BMD protocol
const wheelRanges = {
    lift:   { min: -2, max: 2, default: 0 },
    gamma:  { min: -4, max: 4, default: 0 },
    gain:   { min: 0, max: 16, default: 1 },
    offset: { min: -8, max: 8, default: 0 }
};

let wheelRangeMultiplier = 0.5; // Default: Normal (50%)

function setWheelRange(multiplier, btn) {
    wheelRangeMultiplier = multiplier;
    // Update toggle visual
    const group = btn.closest('.toggle-group');
    group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    // Update all wheel pointers to reflect new range
    wheels.forEach(wheelName => {
        updateWheelPointerFromData(wheelName);
    });
}

function updateWheelPointerFromData(wheelName) {
    const pointer = document.getElementById(`pointer-${wheelName}`);
    if (!pointer) return;
    const pos = calculateWheelPosition(wheelData[wheelName].r, wheelData[wheelName].g, wheelData[wheelName].b, wheelName);
    pointer.style.left = ((pos.x + 1) / 2 * 100) + '%';
    pointer.style.top = ((pos.y + 1) / 2 * 100) + '%';
}

function calculateWheelRGB(x, y, wheelName) {
    const range = wheelRanges[wheelName];
    const baseVal = range.default;
    const maxRange = Math.min(range.max - baseVal, baseVal - range.min) * wheelRangeMultiplier;
    
    const dist = Math.sqrt(x * x + y * y);
    if (dist < 0.01) {
        return { r: baseVal, g: baseVal, b: baseVal };
    }
    
    const normDist = Math.min(1, dist);
    const intensity = normDist * maxRange;
    
    const angle = Math.atan2(y, x);
    
    // Red at 0¬∞, Green at 120¬∞, Blue at 240¬∞
    const r = baseVal + intensity * Math.cos(angle);
    const g = baseVal + intensity * Math.cos(angle - 2.094);
    const b = baseVal + intensity * Math.cos(angle + 2.094);
    
    return { r, g, b };
}

// Inverse function: given RGB, calculate X,Y position of the point
function calculateWheelPosition(r, g, b, wheelName) {
    const range = wheelRanges[wheelName];
    const baseVal = range.default;
    const maxRange = Math.min(range.max - baseVal, baseVal - range.min) * wheelRangeMultiplier;
    
    const dr = r - baseVal;
    const dg = g - baseVal;
    const db = b - baseVal;
    
    if (Math.abs(dr) < 0.001 && Math.abs(dg) < 0.001 && Math.abs(db) < 0.001) {
        return { x: 0, y: 0 };
    }
    
    // Reconstruct x,y components (inverse of the cosine formula)
    const x_comp = dr - (dg + db) * 0.5;
    const y_comp = (dg - db) * 0.866;
    
    // Calculate intensity and normalize
    const intensity = Math.sqrt(x_comp * x_comp + y_comp * y_comp) / 1.5;
    const normDist = Math.min(1, intensity / maxRange);
    
    // Calculate angle
    const angle = Math.atan2(y_comp, x_comp);
    
    return {
        x: normDist * Math.cos(angle),
        y: normDist * Math.sin(angle)  // Same convention as initColorWheels (screen Y)
    };
}

function updateWheelDotFromRGB(wheelName, r, g, b) {
    const pos = calculateWheelPosition(r, g, b, wheelName);
    const pointer = document.getElementById(`pointer-${wheelName}`);
    if (pointer) {
        // pos.x/y are in range -1 to 1, convert to percentage
        pointer.style.left = ((pos.x + 1) / 2 * 100) + '%';
        pointer.style.top = ((pos.y + 1) / 2 * 100) + '%';  // No inversion - same as initColorWheels
    }
}

function resetAllColorWheels() {
    wheels.forEach(wheelName => resetSingleWheel(wheelName));
}

function resetSingleWheel(wheelName) {
    const pointer = document.getElementById(`pointer-${wheelName}`);
    const masterSlider = document.getElementById(`${wheelName}-master`);
    if (pointer) { pointer.style.left = '50%'; pointer.style.top = '50%'; }
    const range = wheelRanges[wheelName];
    const defaultVal = range.default;
    wheelData[wheelName] = { r: defaultVal, g: defaultVal, b: defaultVal, y: defaultVal };
    document.getElementById(`${wheelName}-r`).value = defaultVal.toFixed(2);
    document.getElementById(`${wheelName}-g`).value = defaultVal.toFixed(2);
    document.getElementById(`${wheelName}-b`).value = defaultVal.toFixed(2);
    document.getElementById(`${wheelName}-y`).value = defaultVal.toFixed(2);
    if (masterSlider) masterSlider.value = defaultVal;
    sendWheelValues(wheelName);
}

function updateColorControl(control, value) {
    const v = parseFloat(value);
    document.getElementById(`cc-${control}-val`).textContent = v.toFixed(2);
    
    if (control === 'contrast') {
        multiSubValues['contrast_adjust'][1] = v;
        fetch(`/?cameraId=${currentCamera}&contrast_adjust=${multiSubValues['contrast_adjust'].join(',')}`);
    } else if (control === 'pivot') {
        multiSubValues['contrast_adjust'][0] = v;
        fetch(`/?cameraId=${currentCamera}&contrast_adjust=${multiSubValues['contrast_adjust'].join(',')}`);
    } else if (control === 'saturation') {
        multiSubValues['color_adjust'][1] = v;
        fetch(`/?cameraId=${currentCamera}&color_adjust=${multiSubValues['color_adjust'].join(',')}`);
    } else if (control === 'hue') {
        multiSubValues['color_adjust'][0] = v;
        fetch(`/?cameraId=${currentCamera}&color_adjust=${multiSubValues['color_adjust'].join(',')}`);
    } else if (control === 'lummix') {
        sendParam('luma_mix', v);
    }
}

// === CONTRAST / PIVOT VISUAL CONTROL ===
// === CONTRAST / PIVOT VISUAL CONTROL (HOSFORD SIGMOID) ===
function updateContrastPivot() {
    const contrastInput = document.getElementById('cc-contrast');
    const pivotInput = document.getElementById('cc-pivot');
    
    if (!contrastInput || !pivotInput) return;

    const contrast = parseFloat(contrastInput.value); // Rango 0.0 a 2.0
    const pivot = parseFloat(pivotInput.value);       // Rango 0.0 a 1.0
    
    document.getElementById('cc-contrast-val').textContent = contrast.toFixed(2);
    document.getElementById('cc-pivot-val').textContent = pivot.toFixed(2);
    
    // Pivot marker - positioned at X=Pivot, Y=50%
    const pivotPoint = document.getElementById('pivot-point');
    if (pivotPoint) {
        pivotPoint.style.left = (pivot * 100) + '%';
        pivotPoint.style.top = '50%'; 
    }
    
    const path = document.getElementById('contrast-curve-path');
    if (path) {
        // 1. MAPEO DE PAR√ÅMETRO C A EXPONENTE b
        // C=0 -> b=1 (Lineal), C=1 -> b=7 (S-Curve), C=2 -> b=21 (Z-Curve)
        // Quadratic formula: b = 1 + 2C + 4C¬≤
        const b = 1 + (2 * contrast) + (4 * Math.pow(contrast, 2));
        
        // 2. C√ÅLCULO DE BIAS PARA EL PIVOT
        // k = log(0.5) / log(pivot) - deforma X para que pivot se convierta en 0.5
        const safePivot = Math.max(0.01, Math.min(0.99, pivot));
        const k = Math.log(0.5) / Math.log(safePivot);

        // 3. GENERACI√ìN DE POLIL√çNEA (100 muestras)
        const samples = 100;
        let d = `M 0,100`;

        for (let i = 1; i <= samples; i++) {
            const x = i / samples;
            
            // A. Aplicar desplazamiento de Pivot (Bias)
            const xBiased = Math.pow(x, k);
            
            // B. Apply Hosford Sigmoid Formula
            // f(x) = x^b / (x^b + (1-x)^b)
            const xB = Math.pow(xBiased, b);
            const invXB = Math.pow(1 - xBiased, b);
            
            let y = 0;
            if (xB + invXB !== 0) {
                y = xB / (xB + invXB);
            }
            
            // C. Mapeo a Coordenadas SVG (Y invertida)
            const svgY = 100 - (y * 100);
            d += ` L ${i},${svgY}`;
        }
        
        path.setAttribute('d', d);
        
        // Feedback visual para curva extrema
        if (contrast > 1.8) {
            path.style.stroke = "#e87a35";
            path.style.strokeWidth = "3";
        } else {
            path.style.stroke = "#4a90d9";
            path.style.strokeWidth = "2";
        }
    }
    
    multiSubValues['contrast_adjust'][0] = pivot;
    multiSubValues['contrast_adjust'][1] = contrast;
}

let contrastPivotTimeout = null;
function sendContrastPivot() {
    clearTimeout(contrastPivotTimeout);
    contrastPivotTimeout = setTimeout(() => {
        const pivot = parseFloat(multiSubValues['contrast_adjust'][0].toFixed(2));
        const contrast = parseFloat(multiSubValues['contrast_adjust'][1].toFixed(2));
        fetch(`/?cameraId=${currentCamera}&contrast_adjust=${pivot},${contrast}`);
    }, 50);
}

function resetContrastPivot() {
    document.getElementById('cc-contrast').value = 1;
    document.getElementById('cc-pivot').value = 0.5;
    multiSubValues['contrast_adjust'] = [0.5, 1];
    updateContrastPivot();
    sendContrastPivot();
}

// === HUE / SATURATION VISUAL CONTROL ===
function updateHueSat() {
    const hue = parseFloat(document.getElementById('cc-hue').value);
    const sat = parseFloat(document.getElementById('cc-saturation').value);
    
    document.getElementById('cc-hue-val').textContent = hue.toFixed(2);
    document.getElementById('cc-saturation-val').textContent = sat.toFixed(2);
    
    // Only update UI and cache, don't send
    multiSubValues['color_adjust'][0] = hue;
    multiSubValues['color_adjust'][1] = sat;
}

let hueSatTimeout = null;
function sendHueSat() {
    clearTimeout(hueSatTimeout);
    hueSatTimeout = setTimeout(() => {
        const hue = parseFloat(multiSubValues['color_adjust'][0].toFixed(2));
        const sat = parseFloat(multiSubValues['color_adjust'][1].toFixed(2));
        fetch(`/?cameraId=${currentCamera}&color_adjust=${hue},${sat}`);
    }, 50);
}

function resetHueSat() {
    document.getElementById('cc-hue').value = 0;
    document.getElementById('cc-saturation').value = 1;
    document.getElementById('cc-hue-val').textContent = '0.00';
    document.getElementById('cc-saturation-val').textContent = '1.00';
    multiSubValues['color_adjust'] = [0, 1];
    fetch(`/?cameraId=${currentCamera}&color_adjust=0,1`);
}

function updateLumMix(value) {
    const v = parseFloat(value);
    document.getElementById('cc-lummix-val').textContent = v.toFixed(2);
    cacheValue('luma_mix', v);
}

function sendLumMix() {
    const v = parseFloat(document.getElementById('cc-lummix').value);
    sendParam('luma_mix', v);
}

function resetLumMix() {
    document.getElementById('cc-lummix').value = 1;
    document.getElementById('cc-lummix-val').textContent = '1.00';
    cacheValue('luma_mix', 1);
    sendParam('luma_mix', 1);
}

// === VIDEO MODE CONTROLS ===
function setVideoModeValue(subIndex, value, btn) {
    const group = btn.closest('.toggle-group');
    group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    if (!multiSubValues["video_mode"]) multiSubValues["video_mode"] = [60, 0, 6, 0, 0];
    multiSubValues["video_mode"][subIndex] = value;
    // Actualizar hidden input
    const hiddenInput = document.getElementById(`video_mode_${subIndex}_range`);
    if (hiddenInput) hiddenInput.value = value;
    multiSubOnChange('video_mode');
    
    // If frame rate changed, update shutter presets
    if (subIndex === 0) {
        updateShutterPresets();
    }
}

function multiSubSelectChange(paramKey, subIndex, select) {
    const value = parseInt(select.value);
    if (!multiSubValues[paramKey]) multiSubValues[paramKey] = [];
    multiSubValues[paramKey][subIndex] = value;
    multiSubOnChange(paramKey);
}

function multiSubCheckChange(paramKey, subIndex, checkbox) {
    const value = checkbox.checked ? 1 : 0;
    if (!multiSubValues[paramKey]) multiSubValues[paramKey] = [];
    multiSubValues[paramKey][subIndex] = value;
    multiSubOnChange(paramKey);
}

function setNdDisplayMode(value, btn) {
    const group = btn.closest('.nd-mode-mini');
    group.querySelectorAll('.nd-mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    if (!multiSubValues["nd_filter_stop"]) multiSubValues["nd_filter_stop"] = [0, 0];
    multiSubValues["nd_filter_stop"][1] = value;
    multiSubOnChange('nd_filter_stop');
}

// === SHUTTER PRESETS BASED ON FRAME RATE ===
function getCurrentFrameRate() {
    if (multiSubValues["video_mode"] && multiSubValues["video_mode"][0]) {
        return parseInt(multiSubValues["video_mode"][0]);
    }
    return 60; // default
}

function setShutterToFrameRate() {
    const fps = getCurrentFrameRate();
    setKnobValue('shutter', fps);
}

function setShutterDouble() {
    const fps = getCurrentFrameRate();
    setKnobValue('shutter', fps * 2);
}

function setShutterQuadruple() {
    const fps = getCurrentFrameRate();
    setKnobValue('shutter', fps * 4);
}

function updateShutterPresets() {
    const fps = getCurrentFrameRate();
    const presetsContainer = document.getElementById('shutter-presets');
    if (presetsContainer) {
        const buttons = presetsContainer.querySelectorAll('button');
        if (buttons[0]) buttons[0].textContent = `1/${fps}`;
        if (buttons[1]) buttons[1].textContent = `1/${fps * 2}`;
        if (buttons[2]) buttons[2].textContent = `1/${fps * 4}`;
    }
}

// === AUTO WB TOGGLE ===
function toggleAutoWB(checkbox) {
    if (checkbox.checked) {
        // One-push auto white balance
        triggerVoid('set_auto_wb');
    } else {
        // Restore to manual white balance
        triggerVoid('restore_auto_wb');
    }
}

// === PTZ JOYSTICK ===
function initJoystick() {
    const joystick = document.getElementById('ptz-joystick');
    const handle = document.getElementById('joystick-handle');
    if (!joystick || !handle) return;
    
    let isDragging = false;
    
    const updateJoystick = (e) => {
        const rect = joystick.getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        let x = e.clientX - rect.left - centerX;
        let y = e.clientY - rect.top - centerY;
        const maxRadius = rect.width / 2 - 20;
        const distance = Math.sqrt(x * x + y * y);
        if (distance > maxRadius) {
            x = (x / distance) * maxRadius;
            y = (y / distance) * maxRadius;
        }
        handle.style.left = `${centerX + x}px`;
        handle.style.top = `${centerY + y}px`;
        
        const pan = (x / maxRadius).toFixed(2);
        const tilt = (-y / maxRadius).toFixed(2);
        document.getElementById('pan-value').textContent = pan;
        document.getElementById('tilt-value').textContent = tilt;
        
        multiSubValues["pan_tilt_velocity"] = [parseFloat(pan), parseFloat(tilt)];
        fetch(`/?cameraId=${currentCamera}&pan_tilt_velocity=${pan},${tilt}`);
    };
    
    const resetJoystick = () => {
        handle.style.left = '50%';
        handle.style.top = '50%';
        handle.style.transform = 'translate(-50%, -50%)';
        document.getElementById('pan-value').textContent = '0.00';
        document.getElementById('tilt-value').textContent = '0.00';
        multiSubValues["pan_tilt_velocity"] = [0, 0];
        fetch(`/?cameraId=${currentCamera}&pan_tilt_velocity=0,0`);
    };
    
    joystick.addEventListener('mousedown', (e) => { isDragging = true; updateJoystick(e); });
    document.addEventListener('mousemove', (e) => { if (isDragging) updateJoystick(e); });
    document.addEventListener('mouseup', () => { if (isDragging) { isDragging = false; resetJoystick(); } });
}

// === SYNC ===
const SYNC_CONFIG = { enabled: true, interval: 2500, timeout: 2000 };
let syncTimer = null;
let syncInProgress = false;
let lastKnownState = {};

function startSync() {
    if (syncTimer) clearInterval(syncTimer);
    syncFromArduino();
    syncTimer = setInterval(() => {
        if (!SYNC_CONFIG.enabled || syncInProgress) return;
        syncFromArduino();
    }, SYNC_CONFIG.interval);
}

function stopSync() {
    if (syncTimer) { clearInterval(syncTimer); syncTimer = null; }
}

async function syncFromArduino() {
    if (syncInProgress) return;
    syncInProgress = true;
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), SYNC_CONFIG.timeout);
        const response = await fetch(`/?getParams=${currentCamera}&t=${Date.now()}`, { signal: controller.signal, cache: 'no-store' });
        clearTimeout(timeoutId);
        if (response.ok) {
            const data = await response.json();
            if (data?.params) processSyncData(data);
        }
    } catch (e) {
        // Ignorar errores de timeout/abort silenciosamente
    }
    finally { syncInProgress = false; }
}

function processSyncData(data) {
    const params = data.params;
    
    for (const paramKey in params) {
        const newValue = params[paramKey];
        const stateKey = `cam${data.cameraId}_${paramKey}`;
        const oldValue = lastKnownState[stateKey];
        const hasChanged = JSON.stringify(oldValue) !== JSON.stringify(newValue);
        
        if (hasChanged) {
            lastKnownState[stateKey] = newValue;
            updateFieldFromSync(paramKey, newValue);
        }
    }
}

function updateFieldFromSync(paramKey, value) {
    const activeEl = document.activeElement;
    
    // Manejar controles especiales que no tienen data-paramkey
    if (handleSpecialControlSync(paramKey, value)) {
        return;
    }
    
    document.querySelectorAll(`[data-paramkey="${paramKey}"]`).forEach(el => {
        if (el === activeEl) return;
        const subIndex = el.dataset.subindex;
        let val = Array.isArray(value) && subIndex !== undefined ? value[parseInt(subIndex)] : value;
        if (val !== undefined) {
            updateControlValue(el, val);
            cacheValue(paramKey, val, subIndex !== undefined ? parseInt(subIndex) : null);
        }
    });
}

// Mapping of special parameters to their controls
const specialParamHandlers = {
    'lift_adjust': (v) => updateWheelFromSync('lift', v),
    'gamma_adjust': (v) => updateWheelFromSync('gamma', v),
    'gain_adjust': (v) => updateWheelFromSync('gain', v),
    'offset_adjust': (v) => updateWheelFromSync('offset', v),
    'contrast_adjust': (v) => {
        let values = Array.isArray(v) ? v : (typeof v === 'string' ? v.split(',').map(x => parseFloat(x.trim())) : [0.5, 1]);
        const pivot = values.length > 0 ? parseFloat(values[0]) : 0.5;
        const contrast = values.length > 1 ? parseFloat(values[1]) : 1;
        
        const pivotEl = document.getElementById('cc-pivot');
        const contrastEl = document.getElementById('cc-contrast');
        const pivotValEl = document.getElementById('cc-pivot-val');
        const contrastValEl = document.getElementById('cc-contrast-val');
        
        if (pivotEl) pivotEl.value = pivot;
        if (contrastEl) contrastEl.value = contrast;
        if (pivotValEl) pivotValEl.textContent = pivot.toFixed(2);
        if (contrastValEl) contrastValEl.textContent = contrast.toFixed(2);
        
        multiSubValues['contrast_adjust'] = [pivot, contrast];
        updateContrastPivot();
    },
    'color_adjust': (v) => {
        let values = Array.isArray(v) ? v : (typeof v === 'string' ? v.split(',').map(x => parseFloat(x.trim())) : [0, 1]);
        const hue = values.length > 0 ? parseFloat(values[0]) : 0;
        const sat = values.length > 1 ? parseFloat(values[1]) : 1;
        
        const hueEl = document.getElementById('cc-hue');
        const satEl = document.getElementById('cc-saturation');
        const hueValEl = document.getElementById('cc-hue-val');
        const satValEl = document.getElementById('cc-saturation-val');
        
        if (hueEl) hueEl.value = hue;
        if (satEl) satEl.value = sat;
        if (hueValEl) hueValEl.textContent = hue.toFixed(2);
        if (satValEl) satValEl.textContent = sat.toFixed(2);
        
        multiSubValues['color_adjust'] = [hue, sat];
    },
    'luma_mix': (v) => {
        const val = parseFloat(v);
        const lumEl = document.getElementById('cc-lummix');
        const lumValEl = document.getElementById('cc-lummix-val');
        if (lumEl) lumEl.value = val;
        if (lumValEl) lumValEl.textContent = val.toFixed(2);
    },
    'overlays': (v) => {
        let values = Array.isArray(v) ? v : (typeof v === 'string' ? v.split(',').map(x => parseInt(x.trim())) : [5, 100, 0, 0]);
        multiSubValues['overlays'] = values;
        // Frame Guide Style [0]
        if (values[0] !== undefined) {
            updateOverlayToggleVisual(0, values[0]);
            const h0 = document.getElementById('overlays_0_range');
            if (h0) h0.value = values[0];
        }
        // Grid Overlays [3]
        if (values[3] !== undefined) {
            updateGridCheckboxesFromValue(values[3]);
            const h3 = document.getElementById('overlays_3_range');
            if (h3) h3.value = values[3];
        }
    },
    'exposure_and_focus_tools': (v) => {
        let values = Array.isArray(v) ? v : (typeof v === 'string' ? v.split(',').map(x => parseInt(x.trim())) : [0, 0]);
        multiSubValues['exposure_and_focus_tools'] = values;
        const tools = values[0] || 0;
        const displays = values[1] || 0;
        updateExposureToolsCheckboxesFromValue(tools, displays);
        const h0 = document.getElementById('exposure_and_focus_tools_0_range');
        const h1 = document.getElementById('exposure_and_focus_tools_1_range');
        if (h0) h0.value = tools;
        if (h1) h1.value = displays;
    },
    'focus_assist': (v) => {
        let values = Array.isArray(v) ? v : (typeof v === 'string' ? v.split(',').map(x => parseInt(x.trim())) : [1, 0]);
        multiSubValues['focus_assist'] = values;
        if (values[0] !== undefined) {
            updateFocusAssistToggleVisual(0, values[0]);
            const h0 = document.getElementById('focus_assist_0_range');
            if (h0) h0.value = values[0];
        }
        if (values[1] !== undefined) {
            updateFocusAssistToggleVisual(1, values[1]);
            const h1 = document.getElementById('focus_assist_1_range');
            if (h1) h1.value = values[1];
        }
    },
    'video_mode': (v) => {
        let values = Array.isArray(v) ? v : (typeof v === 'string' ? v.split(',').map(x => parseInt(x.trim())) : [60, 0, 6, 0, 0]);
        multiSubValues['video_mode'] = values;
        // Frame Rate [0]
        if (values[0] !== undefined) {
            updateVideoModeToggleVisual(0, values[0]);
            const h0 = document.getElementById('video_mode_0_range');
            if (h0) h0.value = values[0];
        }
        // M-Rate [1]
        if (values[1] !== undefined) {
            updateVideoModeToggleVisual(1, values[1]);
            const h1 = document.getElementById('video_mode_1_range');
            if (h1) h1.value = values[1];
        }
        // Dimensions [2] - es un select, no toggle
        if (values[2] !== undefined) {
            const sel = document.getElementById('video_mode_2_select');
            if (sel) sel.value = values[2];
        }
        // Scan Mode [3]
        if (values[3] !== undefined) {
            updateVideoModeToggleVisual(3, values[3]);
            const h3 = document.getElementById('video_mode_3_range');
            if (h3) h3.value = values[3];
        }
        // Color Space [4]
        if (values[4] !== undefined) {
            const h4 = document.getElementById('video_mode_4_range');
            if (h4) h4.value = values[4];
        }
        // Update shutter presets if frame rate changed
        updateShutterPresets();
    }
};

function handleSpecialControlSync(paramKey, value) {
    if (specialParamHandlers[paramKey]) {
        specialParamHandlers[paramKey](value);
        return true;
    }
    return false;
}

function updateWheelFromSync(wheelName, value) {
    let values = [];
    if (Array.isArray(value)) {
        values = value.map(v => parseFloat(v));
    } else if (typeof value === 'string') {
        values = value.split(',').map(v => parseFloat(v.trim()));
    } else {
        return;
    }
    
    const range = wheelRanges[wheelName];
    const defaultVal = range ? range.default : 0;
    
    const r = values.length > 0 ? values[0] : defaultVal;
    const g = values.length > 1 ? values[1] : defaultVal;
    const b = values.length > 2 ? values[2] : defaultVal;
    const y = values.length > 3 ? values[3] : defaultVal;
    
    // Check if values are almost the same (tolerance for rounding errors)
    const current = wheelData[wheelName];
    const tolerance = 0.05;
    const sameValues = current &&
        Math.abs(current.r - r) < tolerance &&
        Math.abs(current.g - g) < tolerance &&
        Math.abs(current.b - b) < tolerance &&
        Math.abs(current.y - y) < tolerance;
    
    if (sameValues) return; // Skip update if values haven't changed significantly
    
    wheelData[wheelName] = { r, g, b, y };
    
    const rEl = document.getElementById(`${wheelName}-r`);
    const gEl = document.getElementById(`${wheelName}-g`);
    const bEl = document.getElementById(`${wheelName}-b`);
    const yEl = document.getElementById(`${wheelName}-y`);
    
    if (rEl) rEl.value = r.toFixed(2);
    if (gEl) gEl.value = g.toFixed(2);
    if (bEl) bEl.value = b.toFixed(2);
    if (yEl) yEl.value = y.toFixed(2);
    
    const masterEl = document.getElementById(`${wheelName}-master`);
    if (masterEl) masterEl.value = y;
    
    updateWheelDotFromRGB(wheelName, r, g, b);
}

function forceSync() { lastKnownState = {}; syncFromArduino(); }

// === PRESETS ===
let saveInProgress = false;

function togglePresetsPanel() {
    const panel = document.getElementById('presetsPanel');
    const toggle = document.getElementById('presetsToggle');
    panel.classList.toggle('open');
    toggle.classList.toggle('panel-open');
}

function updatePresetNames() {
    for (let i = 0; i < MAX_PRESETS; i++) {
        const input = document.getElementById("presetName_" + i);
        if (input) {
            const saved = localStorage.getItem(`preset_${currentCamera}_${i}`);
            input.value = saved || `Preset ${i + 1}`;
        }
    }
    fetch('/?listPresets').then(r => r.json()).then(data => {
        if (data?.presets) {
            data.presets.filter(p => p.cameraId === currentCamera).forEach(preset => {
                const input = document.getElementById("presetName_" + preset.presetId);
                if (input && preset.name) {
                    input.value = decodeURIComponent(preset.name);
                    localStorage.setItem(`preset_${currentCamera}_${preset.presetId}`, preset.name);
                }
            });
        }
    }).catch(() => {});
}

function collectAllParameters() {
    const params = {};
    
    document.querySelectorAll('.param-control:not([data-subindex])').forEach(el => {
        const parent = el.closest('.tabcontent');
        if (!parent) return;
        const groupId = parent.id.replace('group_', '');
        if (!selectedParamGroups[groupId]) return;
        const key = el.dataset.paramkey;
        if (!key) return;
        const type = el.dataset.paramtype;
        if (type === 'checkbox') params[key] = el.checked ? 1 : 0;
        else if (type !== 'void') params[key] = el.value;
    });
    
    const multiParams = new Map();
    document.querySelectorAll('.param-control[data-subindex]').forEach(el => {
        const parent = el.closest('.tabcontent');
        if (!parent) return;
        const groupId = parent.id.replace('group_', '');
        if (!selectedParamGroups[groupId]) return;
        const key = el.dataset.paramkey;
        const subIndex = parseInt(el.dataset.subindex);
        if (!key || isNaN(subIndex)) return;
        const type = el.dataset.paramtype;
        let value = type === 'sub-check' ? (el.checked ? 1 : 0) : el.value;
        if (type === 'sub-void') return;
        if (!multiParams.has(key)) multiParams.set(key, []);
        multiParams.get(key).push({ subIndex, value });
    });
    
    multiParams.forEach((entries, key) => {
        entries.sort((a, b) => a.subIndex - b.subIndex);
        const values = [];
        entries.forEach(e => values[e.subIndex] = e.value);
        for (let i = 0; i < values.length; i++) if (values[i] === undefined) values[i] = 0;
        params[key] = values;
    });
    
    // Add special Color Correction controls if group is selected
    if (selectedParamGroups['color_correction']) {
        // Color Wheels - limitar a 2 decimales
        const fmt = (v) => parseFloat(v.toFixed(2));
        params['lift_adjust'] = [fmt(wheelData.lift.r), fmt(wheelData.lift.g), fmt(wheelData.lift.b), fmt(wheelData.lift.y)];
        params['gamma_adjust'] = [fmt(wheelData.gamma.r), fmt(wheelData.gamma.g), fmt(wheelData.gamma.b), fmt(wheelData.gamma.y)];
        params['gain_adjust'] = [fmt(wheelData.gain.r), fmt(wheelData.gain.g), fmt(wheelData.gain.b), fmt(wheelData.gain.y)];
        params['offset_adjust'] = [fmt(wheelData.offset.r), fmt(wheelData.offset.g), fmt(wheelData.offset.b), fmt(wheelData.offset.y)];
        
        // Contrast/Pivot
        params['contrast_adjust'] = multiSubValues['contrast_adjust'] || [0.5, 1];
        
        // Hue/Saturation
        params['color_adjust'] = multiSubValues['color_adjust'] || [0, 1];
        
        // Luma Mix
        const lumMixEl = document.getElementById('cc-lummix');
        if (lumMixEl) params['luma_mix'] = parseFloat(lumMixEl.value);
    }
    
    return params;
}

function showSaveStatus(message, type = 'info', progress = null) {
    let statusEl = document.getElementById('saveStatusElement');
    if (!statusEl) {
        statusEl = document.createElement('div');
        statusEl.id = 'saveStatusElement';
        statusEl.className = 'save-status';
        statusEl.innerHTML = '<div class="message"></div><div class="progress"><div class="progress-bar"></div></div>';
        document.body.appendChild(statusEl);
    }
    statusEl.querySelector('.message').textContent = message;
    statusEl.className = 'save-status ' + type;
    statusEl.querySelector('.progress').style.display = progress !== null ? 'block' : 'none';
    if (progress !== null) statusEl.querySelector('.progress-bar').style.width = progress + '%';
    return statusEl;
}

function hideSaveStatus(delay = 0) {
    setTimeout(() => {
        const el = document.getElementById('saveStatusElement');
        if (el) el.remove();
    }, delay);
}

async function savePreset(idx) {
    if (saveInProgress) return alert('Guardado en progreso');
    saveInProgress = true;
    const presetName = document.getElementById("presetName_" + idx).value || `Preset ${idx + 1}`;
    localStorage.setItem(`preset_${currentCamera}_${idx}`, presetName);
    showSaveStatus(`Saving "${presetName}"...`, 'info', 30);
    try {
        const params = collectAllParameters();
        if (Object.keys(params).length === 0) throw new Error('No parameters');
        let dataString = '';
        for (const key of Object.keys(params)) {
            const value = params[key];
            dataString += `${key}:${Array.isArray(value) ? value.join(',') : value};`;
        }
        showSaveStatus('Sending...', 'info', 60);
        // Body: cameraId=X&presetId=Y&name=Z&data=...
        const body = `cameraId=${currentCamera}&presetId=${idx}&name=${encodeURIComponent(presetName)}&data=${dataString}`;
        const response = await fetch('/savePreset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: body
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        showSaveStatus(`"${presetName}" saved ‚úì`, 'success', 100);
    } catch (error) {
        showSaveStatus(`Error: ${error.message}`, 'error');
    } finally {
        saveInProgress = false;
        hideSaveStatus(2000);
    }
}

async function loadPreset(idx) {
    const presetName = document.getElementById("presetName_" + idx).value || `Preset ${idx + 1}`;
    showSaveStatus(`Loading "${presetName}"...`, 'info', 50);
    try {
        // Formato esperado: /?loadPreset=cameraId,presetIdx&returnValues=1
        const response = await fetch(`/?loadPreset=${currentCamera},${idx}&returnValues=1`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        // El servidor devuelve 'parameters' no 'params'
        const params = data?.parameters || data?.params;
        if (params) {
            // Force refresh by clearing known state for these parameters
            Object.keys(params).forEach(key => {
                delete lastKnownState[`cam${currentCamera}_${key}`];
            });
            // Actualizar UI con los valores del preset
            processSyncData({ cameraId: currentCamera, params: params });
        }
        showSaveStatus(`"${presetName}" loaded ‚úì`, 'success', 100);
    } catch (error) {
        console.error('[Preset] Load error:', error);
        showSaveStatus(`Error: ${error.message}`, 'error');
    } finally {
        hideSaveStatus(2000);
    }
}

function resetSelectedGroupParams() {
    if (!confirm('Reset parameters to default values?')) return;
    showSaveStatus('Resetting...', 'info');
    let count = 0;
    const selectedGroups = Object.entries(selectedParamGroups).filter(([_, sel]) => sel).map(([g]) => g);
    
    document.querySelectorAll('.tabcontent').forEach(tab => {
        const groupId = tab.id.replace('group_', '');
        if (!selectedGroups.includes(groupId)) return;
        
        tab.querySelectorAll('.param-control').forEach(el => {
            const defVal = el.dataset.default;
            const paramKey = el.dataset.paramkey;
            
            if (defVal === undefined) return;
            
            const type = el.dataset.paramtype;
            
            if (type === 'checkbox' || type === 'sub-check') {
                el.checked = defVal === '1';
                el.dispatchEvent(new Event('change'));
            } else if (el.tagName !== 'BUTTON' && type !== 'void') {
                el.value = defVal;
                // No disparar eventos para sub-range, se manejan en bloques especiales
                if (type !== 'sub-range') {
                    el.dispatchEvent(new Event('input'));
                    el.dispatchEvent(new Event('change'));
                }
                
                // Si es un knob-input, actualizar el indicador visual y enviar
                if (el.classList.contains('knob-input') && paramKey) {
                    const knobName = Object.keys(knobConfig).find(k => knobConfig[k].param === paramKey);
                    if (knobName) {
                        knobConfig[knobName].value = parseFloat(defVal);
                        updateKnobIndicator(knobName, parseFloat(defVal));
                        sendKnobValue(knobName);
                    }
                }
                
                // Si es un hidden input de toggle, actualizar el toggle visual
                if (el.type === 'hidden' && paramKey) {
                    updateToggleVisual(paramKey, defVal);
                }
            }
            count++;
        });
    });
    
    // Resetear controles especiales de Color Correction
    if (selectedGroups.includes('color_correction')) {
        // Color Wheels
        resetAllColorWheels();
        
        // Contrast/Pivot
        document.getElementById('cc-pivot').value = 0.5;
        document.getElementById('cc-contrast').value = 1;
        document.getElementById('cc-pivot-val').textContent = '0.50';
        document.getElementById('cc-contrast-val').textContent = '1.00';
        multiSubValues['contrast_adjust'] = [0.5, 1];
        updateContrastPivot();
        sendContrastPivot();
        
        // Hue/Saturation
        document.getElementById('cc-hue').value = 0;
        document.getElementById('cc-saturation').value = 1;
        document.getElementById('cc-hue-val').textContent = '0.00';
        document.getElementById('cc-saturation-val').textContent = '1.00';
        multiSubValues['color_adjust'] = [0, 1];
        sendHueSat();
        
        // Luma Mix
        document.getElementById('cc-lummix').value = 1;
        document.getElementById('cc-lummix-val').textContent = '1.00';
        sendParam('luma_mix', 1);
        
        count += 10;
    }
    
    // Resetear controles especiales de Video
    if (selectedGroups.includes('video')) {
        // Video Mode - reset a defaults (60fps, Regular, UHD, Progressive, YUV)
        multiSubValues['video_mode'] = [60, 0, 6, 0, 0];
        document.getElementById('video_mode_0_range').value = 60;
        document.getElementById('video_mode_1_range').value = 0;
        document.getElementById('video_mode_3_range').value = 0;
        document.getElementById('video_mode_4_range').value = 0;
        const dimSelect = document.getElementById('video_mode_2_select');
        if (dimSelect) dimSelect.value = 6;
        updateVideoModeToggleVisual(0, 60);
        updateVideoModeToggleVisual(1, 0);
        updateVideoModeToggleVisual(3, 0);
        multiSubOnChange('video_mode');
        updateShutterPresets();
        count += 5;
    }
    
    // Resetear controles especiales de Output
    if (selectedGroups.includes('output')) {
        // Frame Guide Style - reset a 16:9 (valor 5), safe area 90%, grids activados
        multiSubValues['overlays'] = [5, 100, 90, 11];
        document.getElementById('overlays_0_range').value = 5;
        document.getElementById('overlays_1_range').value = 100;
        document.getElementById('overlays_2_range').value = 90;
        document.getElementById('overlays_3_range').value = 11;
        // Actualizar displays
        const ov1Input = document.getElementById('overlays_1_input');
        const ov2Input = document.getElementById('overlays_2_input');
        if (ov1Input) ov1Input.value = 100;
        if (ov2Input) ov2Input.value = 90;
        updateOverlayToggleVisual(0, 5);
        // Grid Overlays - activar thirds, crosshairs, horizon
        document.getElementById('grid_thirds').checked = true;
        document.getElementById('grid_crosshairs').checked = true;
        document.getElementById('grid_center').checked = false;
        document.getElementById('grid_horizon').checked = true;
        multiSubOnChange('overlays');
        count += 5;
    }
    
    // Resetear controles especiales de Display
    if (selectedGroups.includes('display')) {
        // Exposure and Focus Tools - reset a todo desactivado
        multiSubValues['exposure_and_focus_tools'] = [0, 0];
        document.getElementById('exposure_and_focus_tools_0_range').value = 0;
        document.getElementById('exposure_and_focus_tools_1_range').value = 0;
        document.getElementById('exposure_and_focus_tools_zebra').checked = false;
        document.getElementById('exposure_and_focus_tools_focus').checked = false;
        document.getElementById('exposure_and_focus_tools_false_color').checked = false;
        document.getElementById('exposure_and_focus_tools_lcd').checked = false;
        document.getElementById('exposure_and_focus_tools_hdmi').checked = false;
        document.getElementById('exposure_and_focus_tools_evf').checked = false;
        document.getElementById('exposure_and_focus_tools_main_sdi').checked = false;
        updateExposureFocusTools();
        
        // Focus Assist - reset a defaults (Colored Lines, Red)
        multiSubValues['focus_assist'] = [1, 0];
        document.getElementById('focus_assist_0_range').value = 1;
        document.getElementById('focus_assist_1_range').value = 0;
        updateFocusAssistToggleVisual(0, 1);
        updateFocusAssistToggleVisual(1, 0);
        fetch(`/?cameraId=${currentCamera}&focus_assist=1,0`);
        count += 12;
    }
    
    showSaveStatus(`${count} controls reset`, 'success');
    hideSaveStatus(2000);
}

// === INIT ===
document.addEventListener('DOMContentLoaded', function() {
    highlightCameraButton(currentCamera);
    showTab('group_lens');
    getOverrides();
    setTimeout(getVmixConnectStatus, 500);
    
    document.querySelectorAll('[id^="group_selector_"]').forEach(cb => {
        const groupId = cb.id.replace('group_selector_', '');
        selectedParamGroups[groupId] = cb.checked;
    });
    
    const saved = localStorage.getItem('selectedParamGroups');
    if (saved) {
        try {
            Object.assign(selectedParamGroups, JSON.parse(saved));
            Object.keys(selectedParamGroups).forEach(group => {
                const cb = document.getElementById(`group_selector_${group}`);
                if (cb) cb.checked = selectedParamGroups[group];
            });
        } catch (e) {}
    }
    
    Object.keys(knobConfig).forEach(initKnob);
    initColorWheels();
    initJoystick();
    initColorSliderEvents();
    updatePresetNames();
    updateShutterPresets();
    updateContrastPivot();
    
    // Inicializar toggles visuales desde multiSubValues
    if (multiSubValues['overlays']) {
        updateOverlayToggleVisual(0, multiSubValues['overlays'][0]);
        updateGridCheckboxesFromValue(multiSubValues['overlays'][3]);
    }
    if (multiSubValues['video_mode']) {
        updateVideoModeToggleVisual(0, multiSubValues['video_mode'][0]);
        updateVideoModeToggleVisual(1, multiSubValues['video_mode'][1]);
        updateVideoModeToggleVisual(3, multiSubValues['video_mode'][3]);
        // Dimensions select
        const dimSelect = document.getElementById('video_mode_2_select');
        if (dimSelect) dimSelect.value = multiSubValues['video_mode'][2];
    }
    if (multiSubValues['focus_assist']) {
        updateFocusAssistToggleVisual(0, multiSubValues['focus_assist'][0]);
        updateFocusAssistToggleVisual(1, multiSubValues['focus_assist'][1]);
    }
    if (multiSubValues['exposure_and_focus_tools']) {
        updateExposureToolsCheckboxesFromValue(
            multiSubValues['exposure_and_focus_tools'][0],
            multiSubValues['exposure_and_focus_tools'][1]
        );
    }
    
    startSync();
});

function initColorSliderEvents() {
    // Solo para wheel masters que no tienen onchange en HTML
    const wheelMasters = ['lift-master', 'gamma-master', 'gain-master', 'offset-master'];
    
    wheelMasters.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', () => {
                const wheelName = id.replace('-master', '');
                sendWheelMaster(wheelName);
            });
        }
    });
}

window.addEventListener('beforeunload', stopSync);
</script>
</body>
</html>
