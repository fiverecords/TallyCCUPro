<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tally Config - TallyCCU Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
:root {
  --bg-primary: #1a1a1c;
  --bg-secondary: #232326;
  --bg-tertiary: #2a2a2e;
  --bg-panel: #1e1e21;
  --bg-input: #333338;
  --bg-hover: #35353a;
  
  --border-color: #3a3a40;
  --border-light: #454550;
  --border-focus: #5a8fd9;
  
  --text-primary: #e8e8e8;
  --text-secondary: #a0a0a5;
  --text-muted: #6a6a70;
  --text-label: #c8c8cc;
  
  --accent-blue: #4a90d9;
  --accent-blue-hover: #5a9fe8;
  --accent-orange: #e87a35;
  --accent-green: #4caf50;
  --accent-red: #e53935;
  
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 12px;
  --spacing-lg: 16px;
  --spacing-xl: 20px;
  
  --radius-sm: 3px;
  --radius-md: 4px;
  --radius-lg: 6px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 13px;
  line-height: 1.4;
  min-height: 100vh;
}

/* === HEADER === */
.header {
  background: linear-gradient(180deg, #2d2d32 0%, var(--bg-secondary) 100%);
  border-bottom: 1px solid var(--border-color);
  padding: var(--spacing-md) var(--spacing-xl);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-left {
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
}

.logo {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.logo-accent { color: var(--accent-orange); }

.logo-sub {
  font-size: 11px;
  font-weight: 400;
  color: var(--text-muted);
  margin-left: var(--spacing-md);
  padding-left: var(--spacing-md);
  border-left: 1px solid var(--border-color);
}

/* === BUTTONS === */
.btn {
  padding: var(--spacing-sm) var(--spacing-lg);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
  border-color: var(--border-light);
}

.btn-primary {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: #fff;
}

.btn-primary:hover {
  background: var(--accent-blue-hover);
  border-color: var(--accent-blue-hover);
}

.btn-success {
  background: #2d5a3d;
  border-color: #3d7a4d;
  color: var(--text-primary);
}

.btn-success:hover {
  background: #3d7a4d;
}

/* === MAIN CONTENT === */
.main-content {
  padding: var(--spacing-xl);
  max-width: 1400px;
  margin: 0 auto;
}

/* === CONTROL PANEL === */
.control-panel {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  margin-bottom: var(--spacing-lg);
  overflow: hidden;
}

.control-panel-header {
  background: var(--bg-tertiary);
  padding: var(--spacing-md) var(--spacing-lg);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.control-panel-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.control-panel-body {
  padding: var(--spacing-lg);
}

/* === VMIX CONFIG === */
.vmix-config {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  flex-wrap: wrap;
}

.vmix-config label {
  font-weight: 500;
  font-size: 12px;
  color: var(--text-label);
}

.vmix-status {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  font-size: 12px;
  color: var(--text-secondary);
}

.status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--bg-input);
}

.status-indicator.connected { 
  background: var(--accent-green);
  box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
}

.status-indicator.disconnected { 
  background: var(--accent-red);
  box-shadow: 0 0 8px rgba(229, 57, 53, 0.5);
}

.status-indicator.reconnecting { 
  background: var(--accent-orange);
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* === INPUTS === */
input[type='text'], input[type='number'] {
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 13px;
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  border-radius: var(--radius-md);
  transition: border-color 0.15s ease;
}

input[type='text']:focus, input[type='number']:focus {
  outline: none;
  border-color: var(--border-focus);
}

#vmixIp { width: 160px; }

/* === CAMERA GRID === */
#camMap {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: var(--spacing-lg);
}

.cam-block {
  background: var(--bg-panel);
  padding: var(--spacing-lg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
  transition: all 0.2s ease;
}

.cam-block:hover { 
  border-color: var(--border-light);
  transform: translateY(-2px);
}

.cam-block h3 {
  margin: 0;
  text-align: center;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  padding-bottom: var(--spacing-md);
  border-bottom: 1px solid var(--border-color);
}

.cam-block .cam-number { 
  color: var(--accent-blue);
  font-weight: 700;
}

.cam-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--spacing-sm);
}

.cam-row label {
  font-size: 12px;
  color: var(--text-secondary);
  min-width: 80px;
}

.cam-row input[type='number'] {
  width: 65px;
  text-align: center;
}

.cam-block .btn {
  width: 100%;
  margin-top: var(--spacing-sm);
  justify-content: center;
}

/* === INFO TEXT === */
.info-text {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: var(--spacing-lg);
  line-height: 1.6;
  padding: var(--spacing-md);
  background: var(--bg-panel);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--accent-blue);
}

/* === GLOBAL ACTIONS === */
.global-actions {
  display: flex;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
  flex-wrap: wrap;
}

/* === SAVE STATUS === */
.save-status {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: var(--spacing-xl) 30px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  z-index: 9999;
  text-align: center;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  font-weight: 500;
}

.save-status.success { 
  border-color: var(--accent-green);
  border-left-width: 4px;
}

.save-status.error { 
  border-color: var(--accent-red);
  border-left-width: 4px;
}

/* === RESPONSIVE === */
@media (max-width: 600px) {
  .header {
    flex-direction: column;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
  }
  
  .vmix-config {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .vmix-status {
    margin-left: 0;
    margin-top: var(--spacing-sm);
  }
  
  #camMap {
    grid-template-columns: 1fr;
  }
}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <span class="logo">Tally<span class="logo-accent">CCU</span> Pro</span>
      <span class="logo-sub">vMix Tally Configuration</span>
    </div>
    <button class="btn" onclick="window.location.href='index.html'">‚Üê Back to CCU Control</button>
  </div>

  <div class="main-content">
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üîó vMix Connection</span>
      </div>
      <div class="control-panel-body">
        <div class="vmix-config">
          <label for="vmixIp">vMix IP Address:</label>
          <input type="text" id="vmixIp" placeholder="192.168.10.140" />
          <button class="btn btn-primary" onclick="saveVmixIp()">Save IP</button>
          <div class="vmix-status">
            <span id="vmixStatusText">Status: Checking...</span>
            <div id="vmixStatusIndicator" class="status-indicator"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üì∑ Camera Mapping</span>
      </div>
      <div class="control-panel-body">
        <p class="info-text">
          Configure the relationship between vMix inputs and Blackmagic cameras. 
          <strong>vMix Input</strong> corresponds to the input number in vMix, and 
          <strong>BMD Cam ID</strong> is the camera identifier in the Blackmagic SDI system (1-8).
        </p>
        <div class="global-actions">
          <button class="btn btn-primary" onclick="saveAllMappings()">üíæ Save All Mappings</button>
          <button class="btn" onclick="resetToDefaults()">‚Üª Reset to Defaults</button>
        </div>
        <div id="camMap"></div>
      </div>
    </div>
  </div>

  <script>
    const NUM_CAMERAS = 10;

    function showStatus(message, type = 'info') {
      const existing = document.getElementById('statusElement');
      if (existing) existing.remove();
      
      const el = document.createElement('div');
      el.id = 'statusElement';
      el.className = 'save-status ' + type;
      el.textContent = message;
      document.body.appendChild(el);
      
      setTimeout(() => el.remove(), 2000);
    }

    function saveVmixIp() {
      const ip = document.getElementById('vmixIp').value.trim();
      if (!ip || !isValidIP(ip)) {
        showStatus("Enter a valid IP (e.g. 192.168.10.140)", 'error');
        return;
      }
      
      fetch(`/?vmixIP=${encodeURIComponent(ip)}`)
        .then(res => res.text())
        .then(() => {
          showStatus("vMix IP saved: " + ip, 'success');
          checkVmixStatus();
        })
        .catch(err => {
          console.error(err);
          showStatus("Error saving IP", 'error');
        });
    }

    function isValidIP(ip) {
      const parts = ip.split('.');
      if (parts.length !== 4) return false;
      return parts.every(part => {
        const num = parseInt(part, 10);
        return num >= 0 && num <= 255 && part === num.toString();
      });
    }

    function checkVmixStatus() {
      fetch('/?getVmixConnect=1')
        .then(r => r.text())
        .then(text => {
          const match = text.match(/\{.*\}/);
          if (match) {
            const data = JSON.parse(match[0]);
            const indicator = document.getElementById('vmixStatusIndicator');
            const statusText = document.getElementById('vmixStatusText');
            const ipInput = document.getElementById('vmixIp');
            
            // Solo actualizar IP si el campo no tiene el foco
            if (data.vmixIP && document.activeElement !== ipInput) {
              ipInput.value = data.vmixIP;
            }
            
            if (data.vmixConnected === true) {
              indicator.className = 'status-indicator connected';
              statusText.textContent = 'Connected to ' + (data.vmixIP || '?');
            } else if (data.vmixConnectEnabled === true) {
              indicator.className = 'status-indicator reconnecting';
              statusText.textContent = 'Reconnecting to ' + (data.vmixIP || '?') + '...';
            } else {
              indicator.className = 'status-indicator disconnected';
              statusText.textContent = 'Disabled';
            }
          }
        })
        .catch(() => {
          document.getElementById('vmixStatusIndicator').className = 'status-indicator';
          document.getElementById('vmixStatusText').textContent = 'Status: Unknown';
        });
    }

    function initCams() {
      const cont = document.getElementById('camMap');
      cont.innerHTML = '';
      
      for (let i = 0; i < NUM_CAMERAS; i++) {
        const divCam = document.createElement('div');
        divCam.className = 'cam-block';
        divCam.innerHTML = `
          <h3>Camera <span class="cam-number">${i + 1}</span></h3>
          <div class="cam-row">
            <label>vMix Input:</label>
            <input type="number" id="tallyCam${i}Input" value="${i + 1}" min="1" max="99"/>
          </div>
          <div class="cam-row">
            <label>BMD Cam ID:</label>
            <input type="number" id="cam${i}ID" value="${i + 1}" min="1" max="8"/>
          </div>
          <button class="btn btn-success" onclick="saveMap(${i})">‚úì Save</button>
        `;
        cont.appendChild(divCam);
      }
    }

    function saveMap(idx) {
      const inpVal = document.getElementById(`tallyCam${idx}Input`).value;
      const camVal = document.getElementById(`cam${idx}ID`).value;
      const url = `/?tallyCam${idx}Input=${inpVal}&cam${idx}ID=${camVal}`;
      
      fetch(url)
        .then(r => r.text())
        .then(() => showStatus(`Camera ${idx + 1}: Configuration saved`, 'success'))
        .catch(e => {
          console.error(e);
          showStatus(`Error saving camera ${idx + 1}`, 'error');
        });
    }

    async function saveAllMappings() {
      showStatus('Saving all mappings...', 'info');
      
      let success = 0;
      let errors = 0;
      
      for (let i = 0; i < NUM_CAMERAS; i++) {
        const inpVal = document.getElementById(`tallyCam${i}Input`).value;
        const camVal = document.getElementById(`cam${i}ID`).value;
        const url = `/?tallyCam${i}Input=${inpVal}&cam${i}ID=${camVal}`;
        
        try {
          await fetch(url);
          success++;
        } catch (e) {
          errors++;
          console.error(`Error saving camera ${i + 1}:`, e);
        }
        
        await new Promise(r => setTimeout(r, 100));
      }
      
      if (errors === 0) {
        showStatus(`All mappings saved (${success}/${NUM_CAMERAS})`, 'success');
      } else {
        showStatus(`Saved ${success}/${NUM_CAMERAS}, errors: ${errors}`, 'error');
      }
    }

    function resetToDefaults() {
      if (!confirm('Reset all values to defaults?')) return;
      
      for (let i = 0; i < NUM_CAMERAS; i++) {
        document.getElementById(`tallyCam${i}Input`).value = i + 1;
        document.getElementById(`cam${i}ID`).value = i + 1;
      }
      
      showStatus('Values reset (remember to save)', 'info');
    }

    window.onload = function() {
      initCams();
      checkVmixStatus();
      setInterval(checkVmixStatus, 5000);
    };
  </script>
</body>
</html>
