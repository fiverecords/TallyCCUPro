<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SD Card - TallyCCU Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
:root {
  --bg-primary: #1a1a1c;
  --bg-secondary: #232326;
  --bg-tertiary: #2a2a2e;
  --bg-panel: #1e1e21;
  --bg-input: #333338;
  --bg-hover: #35353a;
  
  --border-color: #3a3a40;
  --border-light: #454550;
  --border-focus: #5a8fd9;
  
  --text-primary: #e8e8e8;
  --text-secondary: #a0a0a5;
  --text-muted: #6a6a70;
  --text-label: #c8c8cc;
  
  --accent-blue: #4a90d9;
  --accent-blue-hover: #5a9fe8;
  --accent-orange: #e87a35;
  --accent-green: #4caf50;
  --accent-red: #e53935;
  
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 12px;
  --spacing-lg: 16px;
  --spacing-xl: 20px;
  
  --radius-sm: 3px;
  --radius-md: 4px;
  --radius-lg: 6px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 13px;
  line-height: 1.4;
  min-height: 100vh;
}

/* === HEADER === */
.header {
  background: linear-gradient(180deg, #2d2d32 0%, var(--bg-secondary) 100%);
  border-bottom: 1px solid var(--border-color);
  padding: var(--spacing-md) var(--spacing-xl);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-left {
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
}

.logo {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.logo-accent { color: var(--accent-orange); }

.logo-sub {
  font-size: 11px;
  font-weight: 400;
  color: var(--text-muted);
  margin-left: var(--spacing-md);
  padding-left: var(--spacing-md);
  border-left: 1px solid var(--border-color);
}

/* === BUTTONS === */
.btn {
  padding: var(--spacing-sm) var(--spacing-lg);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
  border-color: var(--border-light);
}

.btn-small {
  padding: var(--spacing-xs) var(--spacing-sm);
  font-size: 11px;
}

.btn-danger {
  background: #4a2525;
  border-color: #6a3535;
  color: #f88;
}

.btn-danger:hover {
  background: #6a3535;
}

.btn-danger:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-rename {
  background: #2a3a4a;
  border-color: #3a5a6a;
  color: #8cf;
}

.btn-rename:hover {
  background: #3a5a6a;
}

/* === MAIN CONTENT === */
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: var(--spacing-xl);
}

/* === CONTROL PANEL === */
.control-panel {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  margin-bottom: var(--spacing-lg);
  overflow: hidden;
}

.control-panel-header {
  background: var(--bg-tertiary);
  padding: var(--spacing-md) var(--spacing-lg);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.control-panel-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.control-panel-body {
  padding: var(--spacing-lg);
}

/* === UPLOAD AREA === */
.upload-area {
  border: 2px dashed var(--border-color);
  border-radius: var(--radius-lg);
  padding: 40px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
  background: var(--bg-panel);
}

.upload-area:hover, .upload-area.dragover {
  border-color: var(--accent-blue);
  background: #1a2535;
}

.upload-area.uploading {
  cursor: default;
  border-color: var(--accent-blue);
  background: #1a2535;
}

.upload-area input[type="file"] { display: none; }

.upload-icon { 
  font-size: 48px; 
  margin-bottom: var(--spacing-md);
  opacity: 0.7;
}

.upload-text {
  color: var(--text-secondary);
  font-size: 14px;
}

/* === PROGRESS === */
.progress-container {
  display: none;
  margin-top: var(--spacing-lg);
  padding: var(--spacing-lg);
  background: var(--bg-panel);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-color);
}

.progress-container.show { display: block; }

.progress-filename {
  font-family: 'JetBrains Mono', monospace;
  color: var(--accent-blue);
  margin-bottom: var(--spacing-sm);
  word-break: break-all;
  font-size: 13px;
}

.progress-bar-wrapper {
  background: var(--bg-input);
  border-radius: 10px;
  height: 20px;
  overflow: hidden;
  position: relative;
}

.progress-bar {
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-blue-hover));
  height: 100%;
  width: 0%;
  border-radius: 10px;
  transition: width 0.2s ease;
}

.progress-bar.indeterminate {
  width: 30%;
  animation: indeterminate 1.5s infinite ease-in-out;
}

@keyframes indeterminate {
  0% { margin-left: 0%; }
  50% { margin-left: 70%; }
  100% { margin-left: 0%; }
}

.progress-bar.complete {
  background: linear-gradient(90deg, #2d5a3d, var(--accent-green));
}

.progress-bar.error {
  background: linear-gradient(90deg, #4a2525, var(--accent-red));
}

.progress-info {
  display: flex;
  justify-content: space-between;
  margin-top: var(--spacing-sm);
  font-size: 12px;
  color: var(--text-secondary);
}

.progress-percent {
  font-weight: 600;
  color: var(--text-primary);
}

.progress-status {
  margin-top: var(--spacing-sm);
  font-size: 12px;
  color: var(--text-secondary);
}

.progress-status.success { color: var(--accent-green); }
.progress-status.error { color: var(--accent-red); }

/* === SPINNER === */
.spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid var(--border-color);
  border-top-color: var(--accent-blue);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  vertical-align: middle;
  margin-right: var(--spacing-sm);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* === SELECTION TOOLBAR === */
.selection-toolbar {
  display: none;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md) var(--spacing-lg);
  background: #2a3545;
  border: 1px solid #3a5a6a;
  border-radius: var(--radius-md);
  margin-bottom: var(--spacing-md);
}

.selection-toolbar.show {
  display: flex;
}

.selection-count {
  color: var(--accent-blue);
  font-weight: 600;
  font-size: 13px;
}

.selection-toolbar .btn {
  margin-left: auto;
}

/* === TABLE === */
table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: var(--spacing-md) var(--spacing-sm);
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

th {
  color: var(--text-primary);
  font-weight: 600;
  background: var(--bg-tertiary);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

tr:hover { 
  background: var(--bg-hover);
}

tr.selected {
  background: #1a2535;
}

tr.selected:hover {
  background: #1f2a3a;
}

.col-checkbox {
  width: 40px;
  text-align: center;
}

.file-name {
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-primary);
  font-size: 13px;
}

.file-size {
  color: var(--text-secondary);
  font-size: 12px;
  font-family: 'JetBrains Mono', monospace;
}

.actions { 
  display: flex; 
  gap: 6px; 
  flex-wrap: wrap; 
}

/* === CHECKBOX === */
input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: var(--accent-blue);
  cursor: pointer;
}

/* === STATUS === */
.status {
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: var(--radius-md);
  margin-bottom: var(--spacing-lg);
  display: none;
  font-size: 13px;
}

.status.success {
  background: #1a3a2a;
  border: 1px solid #2d5a3d;
  color: var(--accent-green);
  display: block;
}

.status.error {
  background: #3a1a1a;
  border: 1px solid #5a2525;
  color: var(--accent-red);
  display: block;
}

/* === LOADING === */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.total-info {
  color: var(--text-secondary);
  font-size: 12px;
  margin-top: var(--spacing-md);
  text-align: right;
  font-family: 'JetBrains Mono', monospace;
}

/* === MODAL === */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.show { display: flex; }

.modal-content {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  min-width: 320px;
  max-width: 90%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}

.modal-content h3 {
  margin-bottom: var(--spacing-lg);
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 600;
}

.modal-content input {
  width: 100%;
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
}

.modal-content input:focus {
  outline: none;
  border-color: var(--border-focus);
}

.modal-buttons {
  display: flex;
  gap: var(--spacing-md);
  justify-content: flex-end;
}

.modal-buttons .btn-primary {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: #fff;
}

.modal-buttons .btn-primary:hover {
  background: var(--accent-blue-hover);
}

/* === DELETE PROGRESS === */
.delete-progress {
  margin-top: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--bg-panel);
  border-radius: var(--radius-md);
  font-size: 12px;
  color: var(--text-secondary);
}

.delete-progress-bar {
  height: 4px;
  background: var(--bg-input);
  border-radius: 2px;
  margin-top: var(--spacing-sm);
  overflow: hidden;
}

.delete-progress-fill {
  height: 100%;
  background: var(--accent-red);
  transition: width 0.2s ease;
}

/* === EMPTY STATE === */
.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: var(--spacing-md);
  opacity: 0.5;
}

/* === RESPONSIVE === */
@media (max-width: 600px) {
  .header {
    flex-direction: column;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
  }
  
  .container {
    padding: var(--spacing-md);
  }
  
  .upload-area {
    padding: 30px 20px;
  }
  
  .actions { flex-direction: column; }
  
  th, td { padding: var(--spacing-sm); }
  
  .selection-toolbar {
    flex-wrap: wrap;
  }
  
  .selection-toolbar .btn {
    margin-left: 0;
    width: 100%;
    justify-content: center;
  }
}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <span class="logo">Tally<span class="logo-accent">CCU</span> Pro</span>
      <span class="logo-sub">SD Card Manager</span>
    </div>
    <button class="btn" onclick="location.href='/'">‚Üê Back to CCU Control</button>
  </div>
    
  <div class="container">
    <div id="status" class="status"></div>
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üì§ Upload File</span>
      </div>
      <div class="control-panel-body">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon" id="uploadIcon">üìÅ</div>
          <p class="upload-text" id="uploadText">Drag a file here or click to select</p>
          <input type="file" id="fileInput">
        </div>
        <div class="progress-container" id="progressContainer">
          <div class="progress-filename" id="progressFilename"></div>
          <div class="progress-bar-wrapper">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <div class="progress-info">
            <span id="progressBytes">0 KB / 0 KB</span>
            <span class="progress-percent" id="progressPercent">0%</span>
          </div>
          <div class="progress-status" id="progressStatus"></div>
        </div>
      </div>
    </div>
    
    <div class="control-panel">
      <div class="control-panel-header">
        <span class="control-panel-title">üìÇ Files on SD Card</span>
        <button class="btn btn-small" onclick="loadFiles()">‚Üª Refresh</button>
      </div>
      <div class="control-panel-body">
        <div class="selection-toolbar" id="selectionToolbar">
          <span class="selection-count" id="selectionCount">0 selected</span>
          <button class="btn btn-small" onclick="selectAll()">Select All</button>
          <button class="btn btn-small" onclick="deselectAll()">Deselect All</button>
          <button class="btn btn-small btn-danger" id="deleteSelectedBtn" onclick="deleteSelected()">üóë Delete Selected</button>
        </div>
        <div id="fileList">
          <div class="loading"><span class="spinner"></span> Loading files...</div>
        </div>
        <div class="total-info" id="totalInfo"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="renameModal">
    <div class="modal-content">
      <h3>‚úèÔ∏è Rename File</h3>
      <input type="text" id="renameInput" placeholder="New filename">
      <div class="modal-buttons">
        <button class="btn" onclick="closeRenameModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmRename()">Rename</button>
      </div>
    </div>
  </div>

  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <h3>üóëÔ∏è Delete Files</h3>
      <p id="deleteMessage" style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);"></p>
      <div class="delete-progress" id="deleteProgress" style="display: none;">
        <span id="deleteProgressText">Deleting...</span>
        <div class="delete-progress-bar">
          <div class="delete-progress-fill" id="deleteProgressFill" style="width: 0%"></div>
        </div>
      </div>
      <div class="modal-buttons" id="deleteButtons">
        <button class="btn" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteSelected()">Delete</button>
      </div>
    </div>
  </div>

  <script>
const uploadArea = document.getElementById('uploadArea');
const uploadIcon = document.getElementById('uploadIcon');
const uploadText = document.getElementById('uploadText');
const fileInput = document.getElementById('fileInput');
const progressContainer = document.getElementById('progressContainer');
const progressFilename = document.getElementById('progressFilename');
const progressBar = document.getElementById('progressBar');
const progressBytes = document.getElementById('progressBytes');
const progressPercent = document.getElementById('progressPercent');
const progressStatus = document.getElementById('progressStatus');
const statusEl = document.getElementById('status');

let isUploading = false;
let currentRenameFile = '';
let selectedFiles = new Set();
let allFiles = [];
let isDeleting = false;

// Protected files that cannot be deleted
const PROTECTED_FILES = ['index.html', 'tally.html', 'sdcard.html'];

uploadArea.addEventListener('click', () => {
  if (!isUploading) fileInput.click();
});

uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  if (!isUploading) uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  if (!isUploading && e.dataTransfer.files.length > 0) {
    checkAndUpload(e.dataTransfer.files[0]);
  }
});

fileInput.addEventListener('change', () => {
  if (!isUploading && fileInput.files.length > 0) {
    checkAndUpload(fileInput.files[0]);
  }
});

async function checkAndUpload(file) {
  try {
    const response = await fetch('/?fileExists=' + encodeURIComponent(file.name));
    const data = await response.json();
    
    if (data.exists) {
      if (!confirm('File "' + file.name + '" already exists.\n\nDo you want to overwrite it?')) {
        fileInput.value = '';
        return;
      }
    }
    
    uploadFile(file);
  } catch (e) {
    uploadFile(file);
  }
}

function uploadFile(file) {
  isUploading = true;
  
  uploadArea.classList.add('uploading');
  uploadIcon.innerHTML = '<span class="spinner"></span>';
  uploadText.textContent = 'Uploading file...';
  
  progressContainer.classList.add('show');
  progressFilename.textContent = file.name;
  progressBar.style.width = '0%';
  progressBar.className = 'progress-bar';
  progressBytes.textContent = '0 KB / ' + formatSize(file.size);
  progressPercent.textContent = '0%';
  progressStatus.textContent = '';
  progressStatus.className = 'progress-status';
  
  const formData = new FormData();
  formData.append('file', file);
  
  const xhr = new XMLHttpRequest();
  
  xhr.upload.addEventListener('progress', (e) => {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      progressBar.style.width = percent + '%';
      progressPercent.textContent = percent + '%';
      progressBytes.textContent = formatSize(e.loaded) + ' / ' + formatSize(e.total);
      
      if (percent < 100) {
        progressStatus.textContent = 'Sending data...';
      } else {
        progressStatus.textContent = 'Saving to SD card...';
        progressBar.classList.add('indeterminate');
      }
    }
  });
  
  xhr.addEventListener('load', () => {
    progressBar.classList.remove('indeterminate');
    
    if (xhr.status === 200) {
      try {
        const data = JSON.parse(xhr.responseText);
        if (data.success) {
          progressBar.style.width = '100%';
          progressBar.classList.add('complete');
          progressStatus.textContent = '‚úì File uploaded successfully';
          progressStatus.classList.add('success');
          showStatus('File "' + file.name + '" uploaded successfully', 'success');
          loadFiles();
        } else {
          uploadError(data.message || 'Unknown error');
        }
      } catch (e) {
        uploadError('Invalid server response');
      }
    } else {
      uploadError('HTTP error ' + xhr.status);
    }
    
    finishUpload();
  });
  
  xhr.addEventListener('error', () => {
    progressBar.classList.remove('indeterminate');
    uploadError('Connection error');
    finishUpload();
  });
  
  xhr.addEventListener('timeout', () => {
    progressBar.classList.remove('indeterminate');
    uploadError('Timeout');
    finishUpload();
  });
  
  xhr.open('POST', '/upload');
  xhr.timeout = 120000;
  xhr.send(formData);
}

function uploadError(message) {
  progressBar.style.width = '100%';
  progressBar.classList.add('error');
  progressStatus.textContent = '‚úó Error: ' + message;
  progressStatus.classList.add('error');
  showStatus('Upload error: ' + message, 'error');
}

function finishUpload() {
  isUploading = false;
  uploadArea.classList.remove('uploading');
  uploadIcon.innerHTML = 'üìÅ';
  uploadText.textContent = 'Drag a file here or click to select';
  fileInput.value = '';
  
  setTimeout(() => {
    progressContainer.classList.remove('show');
  }, 3000);
}

async function loadFiles() {
  const fileList = document.getElementById('fileList');
  fileList.innerHTML = '<div class="loading"><span class="spinner"></span> Loading files...</div>';
  selectedFiles.clear();
  updateSelectionUI();
  
  try {
    const response = await fetch('/?listFiles&t=' + Date.now());
    const data = await response.json();
    
    if (data.files && data.files.length > 0) {
      allFiles = data.files.sort((a, b) => a.name.localeCompare(b.name));
      let html = '<table><thead><tr><th class="col-checkbox"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"></th><th>Name</th><th>Size</th><th>Actions</th></tr></thead><tbody>';
      
      let totalSize = 0;
      
      allFiles.forEach(file => {
        totalSize += file.size;
        const safeName = escapeHtml(file.name);
        const isProtected = PROTECTED_FILES.includes(file.name);
        const checkboxDisabled = isProtected ? 'disabled' : '';
        const rowClass = selectedFiles.has(file.name) ? 'selected' : '';
        
        html += '<tr class="' + rowClass + '" data-filename="' + safeName + '">' +
          '<td class="col-checkbox"><input type="checkbox" ' + checkboxDisabled + ' onchange="toggleFileSelection(\'' + safeName + '\', this.checked)" ' + (selectedFiles.has(file.name) ? 'checked' : '') + '></td>' +
          '<td class="file-name">' + safeName + (isProtected ? ' <span style="color:var(--text-muted);font-size:10px;">üîí</span>' : '') + '</td>' +
          '<td class="file-size">' + formatSize(file.size) + '</td>' +
          '<td class="actions">' +
            '<button class="btn btn-small" onclick="downloadFile(\'' + safeName + '\')" title="Download">‚¨á</button>' +
            '<button class="btn btn-small btn-rename" onclick="renameFile(\'' + safeName + '\')" title="Rename">‚úé</button>' +
            '<button class="btn btn-small btn-danger" onclick="deleteFile(\'' + safeName + '\')" title="Delete" ' + (isProtected ? 'disabled' : '') + '>üóë</button>' +
          '</td>' +
        '</tr>';
      });
      
      html += '</tbody></table>';
      fileList.innerHTML = html;
      
      document.getElementById('totalInfo').textContent = 
        data.files.length + ' files ‚Ä¢ ' + formatSize(totalSize) + ' total';
    } else {
      allFiles = [];
      fileList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No files on SD card</p></div>';
      document.getElementById('totalInfo').textContent = '';
    }
  } catch (e) {
    fileList.innerHTML = '<div class="empty-state" style="color:var(--accent-red)"><div class="empty-state-icon">‚ö†</div><p>Error loading files</p></div>';
  }
}

// === SELECTION FUNCTIONS ===

function toggleFileSelection(filename, checked) {
  if (checked) {
    selectedFiles.add(filename);
  } else {
    selectedFiles.delete(filename);
  }
  updateSelectionUI();
  updateRowHighlight(filename, checked);
}

function toggleSelectAll(checked) {
  if (checked) {
    selectAll();
  } else {
    deselectAll();
  }
}

function selectAll() {
  allFiles.forEach(file => {
    if (!PROTECTED_FILES.includes(file.name)) {
      selectedFiles.add(file.name);
    }
  });
  updateAllCheckboxes();
  updateSelectionUI();
}

function deselectAll() {
  selectedFiles.clear();
  updateAllCheckboxes();
  updateSelectionUI();
}

function updateAllCheckboxes() {
  const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
  checkboxes.forEach(cb => {
    const row = cb.closest('tr');
    const filename = row.dataset.filename;
    const isSelected = selectedFiles.has(filename);
    cb.checked = isSelected;
    row.classList.toggle('selected', isSelected);
  });
  
  // Update "select all" checkbox
  const selectAllCb = document.getElementById('selectAllCheckbox');
  const selectableCount = allFiles.filter(f => !PROTECTED_FILES.includes(f.name)).length;
  if (selectAllCb) {
    selectAllCb.checked = selectedFiles.size === selectableCount && selectableCount > 0;
    selectAllCb.indeterminate = selectedFiles.size > 0 && selectedFiles.size < selectableCount;
  }
}

function updateRowHighlight(filename, selected) {
  const row = document.querySelector('tr[data-filename="' + filename + '"]');
  if (row) {
    row.classList.toggle('selected', selected);
  }
  
  // Update "select all" checkbox state
  const selectAllCb = document.getElementById('selectAllCheckbox');
  const selectableCount = allFiles.filter(f => !PROTECTED_FILES.includes(f.name)).length;
  if (selectAllCb) {
    selectAllCb.checked = selectedFiles.size === selectableCount && selectableCount > 0;
    selectAllCb.indeterminate = selectedFiles.size > 0 && selectedFiles.size < selectableCount;
  }
}

function updateSelectionUI() {
  const toolbar = document.getElementById('selectionToolbar');
  const count = document.getElementById('selectionCount');
  const deleteBtn = document.getElementById('deleteSelectedBtn');
  
  if (selectedFiles.size > 0) {
    toolbar.classList.add('show');
    count.textContent = selectedFiles.size + ' selected';
    deleteBtn.disabled = false;
  } else {
    toolbar.classList.remove('show');
    deleteBtn.disabled = true;
  }
}

// === DELETE FUNCTIONS ===

function deleteSelected() {
  if (selectedFiles.size === 0 || isDeleting) return;
  
  const fileList = Array.from(selectedFiles);
  document.getElementById('deleteMessage').textContent = 
    'Are you sure you want to delete ' + fileList.length + ' file' + (fileList.length > 1 ? 's' : '') + '?\n\nThis action cannot be undone.';
  document.getElementById('deleteProgress').style.display = 'none';
  document.getElementById('deleteButtons').style.display = 'flex';
  document.getElementById('confirmDeleteBtn').disabled = false;
  document.getElementById('deleteModal').classList.add('show');
}

function closeDeleteModal() {
  if (!isDeleting) {
    document.getElementById('deleteModal').classList.remove('show');
  }
}

async function confirmDeleteSelected() {
  if (isDeleting) return;
  
  const fileList = Array.from(selectedFiles);
  if (fileList.length === 0) return;
  
  isDeleting = true;
  document.getElementById('confirmDeleteBtn').disabled = true;
  document.getElementById('deleteProgress').style.display = 'block';
  
  let deleted = 0;
  let errors = 0;
  
  for (let i = 0; i < fileList.length; i++) {
    const filename = fileList[i];
    document.getElementById('deleteProgressText').textContent = 
      'Deleting ' + (i + 1) + ' of ' + fileList.length + ': ' + filename;
    document.getElementById('deleteProgressFill').style.width = 
      Math.round(((i + 1) / fileList.length) * 100) + '%';
    
    try {
      const response = await fetch('/?deleteFile=' + encodeURIComponent(filename));
      const data = await response.json();
      
      if (data.success) {
        deleted++;
        selectedFiles.delete(filename);
      } else {
        errors++;
      }
    } catch (e) {
      errors++;
    }
    
    // Small delay between deletions to not overwhelm the Arduino
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  isDeleting = false;
  document.getElementById('deleteModal').classList.remove('show');
  
  if (errors === 0) {
    showStatus(deleted + ' file' + (deleted > 1 ? 's' : '') + ' deleted successfully', 'success');
  } else {
    showStatus(deleted + ' deleted, ' + errors + ' failed', errors === fileList.length ? 'error' : 'success');
  }
  
  loadFiles();
}

async function deleteFile(filename) {
  if (PROTECTED_FILES.includes(filename)) {
    showStatus('Cannot delete protected system file', 'error');
    return;
  }
  
  if (!confirm('Delete "' + filename + '"?\n\nThis action cannot be undone.')) {
    return;
  }
  
  try {
    const response = await fetch('/?deleteFile=' + encodeURIComponent(filename));
    const data = await response.json();
    
    if (data.success) {
      showStatus('File "' + filename + '" deleted', 'success');
      loadFiles();
    } else {
      showStatus('Error deleting file', 'error');
    }
  } catch (e) {
    showStatus('Connection error', 'error');
  }
}

function downloadFile(filename) {
  window.location.href = '/?download=' + encodeURIComponent(filename);
}

function renameFile(filename) {
  currentRenameFile = filename;
  document.getElementById('renameInput').value = filename;
  document.getElementById('renameModal').classList.add('show');
  document.getElementById('renameInput').focus();
  document.getElementById('renameInput').select();
}

function closeRenameModal() {
  document.getElementById('renameModal').classList.remove('show');
  currentRenameFile = '';
}

async function confirmRename() {
  const newName = document.getElementById('renameInput').value.trim();
  
  if (!newName) {
    showStatus('Enter a valid name', 'error');
    return;
  }
  
  if (newName === currentRenameFile) {
    closeRenameModal();
    return;
  }
  
  try {
    const url = '/?renameFile=' + encodeURIComponent(currentRenameFile) + '&to=' + encodeURIComponent(newName);
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.success) {
      showStatus('File renamed to "' + newName + '"', 'success');
      loadFiles();
    } else {
      showStatus('Error renaming (name already exists?)', 'error');
    }
  } catch (e) {
    showStatus('Connection error', 'error');
  }
  
  closeRenameModal();
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showStatus(message, type) {
  statusEl.textContent = message;
  statusEl.className = 'status ' + type;
  setTimeout(() => { statusEl.className = 'status'; }, 5000);
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeRenameModal();
    closeDeleteModal();
  }
  if (e.key === 'Enter' && document.getElementById('renameModal').classList.contains('show')) {
    confirmRename();
  }
});

loadFiles();
  </script>
</body>
</html>
